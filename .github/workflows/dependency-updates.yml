# Automated Dependency Audit Workflow
# Runs weekly to check for security vulnerabilities and creates PRs for fixes
#
# Schedule: Every Sunday at midnight UTC
# Can also be triggered manually via workflow_dispatch

name: Dependency Audit

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Automatically create PR for fixable vulnerabilities'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  audit:
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.audit.outputs.has_vulnerabilities }}
      fixable_count: ${{ steps.audit.outputs.fixable_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run npm audit
        id: audit
        run: |
          # Run audit and capture output
          npm audit --json > audit-results.json 2>&1 || true

          # Parse results
          TOTAL=$(jq '.metadata.vulnerabilities.total // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)

          echo "Total vulnerabilities: $TOTAL"
          echo "  - Low: $LOW"
          echo "  - Moderate: $MODERATE"
          echo "  - High: $HIGH"
          echo "  - Critical: $CRITICAL"

          # Check if there are vulnerabilities
          if [ "$TOTAL" -gt 0 ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT

            # Try to determine how many are fixable
            npm audit fix --dry-run --json > audit-fix-preview.json 2>&1 || true
            FIXABLE=$(jq '.metadata.vulnerabilities.total // 0' audit-fix-preview.json)
            echo "fixable_count=$((TOTAL - FIXABLE))" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "fixable_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v6
        with:
          name: audit-results
          path: |
            audit-results.json
            audit-fix-preview.json
          retention-days: 30

  create-fix-pr:
    needs: audit
    if: needs.audit.outputs.has_vulnerabilities == 'true' && (github.event.inputs.auto_fix != 'false')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Create fix branch
        id: branch
        run: |
          BRANCH_NAME="security/dependency-audit-$(date +%Y%m%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"

      - name: Apply security fixes
        id: fix
        run: |
          # Run npm audit fix
          npm audit fix --legacy-peer-deps 2>&1 | tee fix-output.txt || true

          # Check if there are changes
          if git diff --quiet package-lock.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.fix.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json package-lock.json
          git commit -m "fix(security): apply automated dependency security fixes

          This PR was automatically generated by the weekly dependency audit workflow.

          Fixes applied via \`npm audit fix\`."
          git push origin "${{ steps.branch.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.fix.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.branch_name }}
          base: main
          title: "fix(security): Automated dependency security fixes"
          body: |
            ## Automated Security Fixes

            This PR was automatically generated by the weekly dependency audit workflow.

            ### Changes
            - Applied `npm audit fix` to resolve known vulnerabilities

            ### Vulnerabilities Found
            - Total: ${{ needs.audit.outputs.fixable_count }} fixable vulnerabilities

            ### Review Checklist
            - [ ] Verify the changes don't break existing functionality
            - [ ] Run the test suite
            - [ ] Check for any breaking changes in updated packages

            ---
            ðŸ¤– Generated by [AgileFlow Dependency Audit](.github/workflows/dependency-updates.yml)
          labels: |
            security
            dependencies
            automated
          draft: false

  notify-unfixable:
    needs: audit
    if: needs.audit.outputs.has_vulnerabilities == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Create issue for unfixable vulnerabilities
        uses: actions/github-script@v8
        with:
          script: |
            const vulnerabilities = '${{ needs.audit.outputs.fixable_count }}';

            // Check if there's already an open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existingIssue = existingIssues.data.find(
              issue => issue.title.includes('Dependency Audit Report')
            );

            const body = `## Weekly Dependency Audit Report

            **Date:** ${new Date().toISOString().split('T')[0]}
            **Vulnerabilities Found:** ${{ needs.audit.outputs.fixable_count }}

            ### Action Required

            Some vulnerabilities may require manual intervention:
            - Review the [audit results artifact](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - Consider updating packages manually with \`npm update\`
            - Some fixes may require major version updates

            ### Running Locally

            \`\`\`bash
            # Check for vulnerabilities
            npm audit

            # Apply automatic fixes
            npm audit fix

            # Force fixes (may include breaking changes)
            npm audit fix --force
            \`\`\`

            ---
            ðŸ¤– Generated by [AgileFlow Dependency Audit](.github/workflows/dependency-updates.yml)
            `;

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Dependency Audit Report - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['security', 'dependencies']
              });
            }
