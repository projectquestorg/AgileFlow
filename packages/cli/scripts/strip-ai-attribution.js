#!/usr/bin/env node
/**
 * strip-ai-attribution.js - PreToolUse hook for Bash tool
 *
 * Blocks git commit commands that contain AI attribution patterns
 * (Co-Authored-By, "Generated with Claude", noreply@anthropic.com, etc.)
 *
 * Exit codes:
 *   0 - Allow command
 *   2 - Block command (AI attribution detected)
 *
 * Usage: Configured as PreToolUse hook in .claude/settings.json
 */

let input = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', chunk => {
  input += chunk;
});
process.stdin.on('end', () => {
  try {
    const data = JSON.parse(input);
    const command = data.tool_input?.command || '';

    // Only check git commit commands
    if (!/git\s+commit/i.test(command)) {
      process.exit(0);
    }

    // AI attribution patterns (case-insensitive)
    const patterns = [
      /Co-Authored-By:/i,
      /noreply@anthropic\.com/i,
      /noreply@openai\.com/i,
      /noreply@google\.com/i,
      /Generated with \[?Claude/i,
      /Generated by Claude/i,
      /Generated with \[?GPT/i,
      /Generated by GPT/i,
      /Generated by AI/i,
      /\u{1F916}/u, // Robot emoji
    ];

    for (const pattern of patterns) {
      if (pattern.test(command)) {
        process.stderr.write('[BLOCKED] AI attribution detected in commit message\n');
        process.stderr.write(
          'Remove Co-Authored-By, "Generated with", or AI mentions from your commit.\n'
        );
        process.stderr.write('Retry with a clean conventional commit message.\n');
        process.exit(2);
      }
    }

    process.exit(0);
  } catch {
    // Fail open on parse errors
    process.exit(0);
  }
});

// Fail open on timeout
setTimeout(() => process.exit(0), 4000);
