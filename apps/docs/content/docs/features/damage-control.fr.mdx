---
title: Contrôle des dégâts
description: Protégez votre base de code des commandes destructrices à l'aide des hooks PreToolUse
---
# Contrôle des dégâts

Damage Control est un système de sécurité qui empêche les agents IA d'exécuter des commandes destructrices ou dangereuses. Il utilise les **hooks PreToolUse** de Claude Code pour valider les commandes avant leur exécution.

## Démarrage rapide

```bash
# Enable with interactive wizard
/agileflow:configure damagecontrol

# Or command line
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol

# Then restart Claude Code (Cmd+Q / Ctrl+Q)
```

## Comment ça marche

<image>
  <source media="(prefers-color-scheme: dark)" srcset="/images/docs/features/damage-control-flow.dark.svg" />
  <img alt="Flux de contrôle des dommages" src="/images/docs/features/damage-control-flow.light.svg" />
</image>

Damage Control utilise trois hooks distincts :

| Crochet | Fichier | Protège contre |
|------|------|------------------|
| **Bash** | `damage-control-bash.js` | Commandes shell dangereuses |
| **Modifier** | `damage-control-edit.js` | Modifications des fichiers protégés |
| **Écrire** | `damage-control-write.js` | Écrit dans des emplacements protégés |

---

## Couches de protection

### Modèles de commandes Bash

**Automatiquement bloqué :**
- Suppressions destructives : `rm -rf /`, `rm -rf ..`, suppressions récursives
- Forcer la poussée : `git push --force`, `git push -f`
- Réinitialisation matérielle : `git reset --hard`
- Destruction de la base de données : `DROP TABLE`, `TRUNCATE TABLE`, `DELETE FROM ... ;`
- Opérations sur disque : `dd if=`, `mkfs.`, `fdisk`
- Exposition des informations d'identification : `cat *.pem`, `cat id_rsa`
- Forcer la mise à mort : `kill -9`, `killall`, `pkill -9`
- Et plus de 30 modèles supplémentaires

** Nécessite une confirmation (demander des modèles) :**
- Suppression de la base de données avec WHERE : `DELETE FROM table WHERE ...`
- Publication : `npm publish`
- Pousser vers principal : `git push origin main`
- Cloud CLI supprime : `aws delete`, `gcloud delete`, `az delete`
- Mises à jour de la base de données : `UPDATE ... SET ... WHERE`
- Suppression de node_modules : `rm -rf node_modules`

### Niveaux de protection du chemin

| Niveau | Lire | Écrire | Modifier | Supprimer |
|-------|------|-------|------|--------|
| **Accès zéro** | Non | Non | Non | Non |
| **Lecture seule** | Oui | Non | Non | Non |
| **Pas de suppression** | Oui | Oui | Oui | Non |

**Chemins d'accès zéro :**
- Clés SSH : `~/.ssh/`, `id_rsa`, `id_ed25519`
- Identifiants cloud : `~/.aws/`, `~/.gnupg/`, `~/.config/gh/`
- Secrets de fabrication : `.env.production`, `.env.local`, `.env.secrets`
- Clés privées : `*.pem`, `*.key`, `credentials.json`

**Chemins en lecture seule :**
- Configuration du shell : `~/.bashrc`, `~/.zshrc`, `~/.gitconfig`
- Verrouiller les fichiers : `package-lock.json`, `yarn.lock`
- Système : `/etc/`

**Aucun chemin de suppression :**
- Noyau AgileFlow : `.agileflow/`, `.claude/`
- Statut du projet : `docs/09-agents/status.json`
- Contrôle des sources : `.git/`
- Racines du projet : `README.md`, `package.json`

---

## Guide de configuration

### Prérequis

-AgileFlow v2.78.0+
- Claude Code (dernier)
- Répertoire `.agileflow` installé

### Étape 1 : Choisissez le niveau de protection

**Standard (recommandé)**
- Correspondance rapide des modèles uniquement
- Latence de 0 ms ajoutée
- Plus de 40 modèles dangereux bloqués
- Parfait pour la plupart des projets

**Amélioré**
- Évaluation Standard + AI pour les menaces inconnues
-Latence de 50 à 100 ms ajoutée
- Mieux pour le code très sensible
- Fonctionnalité expérimentale

**Minime**
- Protection du chemin uniquement
- Aucun modèle de commande bash

### Étape 2 : Activer

```bash
/agileflow:configure damagecontrol
```

Ou :

```bash
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol
```

### Étape 3 : Vérifier

```bash
# Check patterns file
ls -la .agileflow/config/damage-control-patterns.yaml

# Check hooks configured
grep -A 5 "PreToolUse" .claude/settings.json

# Test (should be blocked)
rm -rf /
```

### Étape 4 : Redémarrez Claude Code

**Important :** Les hooks ne prennent effet qu'après le redémarrage.

```bash
# Complete quit (Cmd+Q / Ctrl+Q)
# Wait 5 seconds
# Reopen Claude Code
```

---

##Architecture

### Flux du système

<image>
  <source media="(prefers-color-scheme: dark)" srcset="/images/docs/features/damage-control-arch.dark.svg" />
  <img alt="Architecture de contrôle des dommages" src="/images/docs/features/damage-control-arch.light.svg" />
</image>

### Exemple de crochet Bash

```javascript
// Input: { command: "rm -rf /" }
// Pattern: /\brm\s+-rf\s+/
// Test: pattern.test("rm -rf /") = true
// Result: BLOCKED (exit code 2)
```

### Modifier un exemple de hook

```javascript
// Input: { file_path: "/Users/me/.ssh/id_rsa" }
// Protected: zeroAccessPaths: ["~/.ssh/"]
// Test: path.startsWith(expandedPath)
// Result: BLOCKED (exit code 2)
```

### Codes de sortie

| Codes | Signification | Actions |
|------|---------|--------|
| 0 | Autoriser | L'outil s'exécute normalement |
| 2 | Bloquer | Exécution de l'outil empêchée |

### Philosophie de l'ouverture en cas d'échec

Si le fichier de modèles est corrompu ou manquant, les commandes sont **autorisées** (non bloquées). Cela garantit un sa casséLe système fety ne bloque pas toutes les opérations.

---

##Configuration

### Fichier de modèles

Emplacement : `.agileflow/config/damage-control-patterns.yaml`

```yaml
# Blocked bash commands
bashToolPatterns:
  - pattern: 'rm\s+-rf\s+/'
    reason: "Recursive delete from root"
  - pattern: 'git\s+push\s+--force'
    reason: "Force push blocked"

# Requires confirmation
askPatterns:
  - pattern: 'npm\s+publish'
    reason: "Publishing to npm"
  - pattern: 'git\s+push\s+origin\s+main'
    reason: "Pushing to main"

# Zero access (no read/write/edit)
zeroAccessPaths:
  - '~/.ssh/'
  - '.env'

# Read-only (can read, not modify)
readOnlyPaths:
  - '~/.bashrc'
  - 'package-lock.json'

# No delete (can read/write, not delete)
noDeletePaths:
  - '.agileflow/'
  - '.git/'
```

### Ajout de modèles personnalisés

Modifiez directement le fichier de modèles :

```yaml
# Add to bashToolPatterns
bashToolPatterns:
  # ... existing patterns ...
  - pattern: 'my-dangerous-command'
    reason: "Custom block reason"

# Add to askPatterns
askPatterns:
  # ... existing patterns ...
  - pattern: 'deploy\s+production'
    reason: "Production deployment"
```

### Configuration des crochets

Dans `.claude/settings.json` :

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-bash.js"
        }]
      },
      {
        "matcher": "Edit",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-edit.js"
        }]
      },
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-write.js"
        }]
      }
    ]
  }
}
```

---

## FAQ et dépannage

### Questions générales

**Q : Le contrôle des dommages ralentit-il les commandes ?**

R : Non, cela ajoute moins de 5 ms par commande. La correspondance de modèles est optimisée.

**Q : Puis-je le désactiver temporairement ?**

R : Oui :
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
```
Puis redémarrez Claude Code. Réactivez avec `--enable=damagecontrol`.

**Q : Que se passe-t-il si cela bloque quelque chose qui devrait être autorisé ?**

R : Modifiez `.agileflow/config/damage-control-patterns.yaml` :
1. Rendre le modèle plus spécifique
2. Déplacez-le de `bashToolPatterns` à `askPatterns`
3. Retirez-le si vous n'en avez pas besoin

Puis redémarrez Claude Code.

**Q : Protège-t-il également contre les erreurs humaines ?**

R : Oui. Toutes les commandes passent par des hooks, qu'elles proviennent de vous ou de l'IA.

**Q : Les modèles peuvent-ils être contournés ?**

R : Pas facilement. Les motifs correspondentchaînes de commandes réelles. Des solutions de contournement simples telles que `r m -rf` créent des erreurs de syntaxe.

### Problèmes de configuration

**Q : Les hooks ne fonctionnent pas après leur activation.**

R : Cause la plus courante : vous n'avez pas redémarré Claude Code :
1. Fermez complètement (Cmd+Q / Ctrl+Q)
2. Attendez 5 secondes
3. Rouvrir
4. Testez avec `rm -rf /`

**Q : Comment puis-je savoir si cela fonctionne ?**

R : Testez une commande bloquée :
```bash
rm -rf /
# Should see: [BLOCKED] rm with absolute path
```

**Q : Impossible de trouver le fichier de modèles.**

R : Créez-le :
```bash
mkdir -p .agileflow/config
cp .agileflow/templates/damage-control-patterns.yaml .agileflow/config/
```

**Q : settings.json a été corrompu.**

R : Réparez-le :
```bash
cp .claude/settings.json .claude/settings.json.broken
node .agileflow/scripts/agileflow-configure.js --migrate
# If that fails:
rm .claude/settings.json
/agileflow:configure damagecontrol
```

### Matrice de dépannage

| Problème | Parce que | Solutions |
|---------|-------|----------|
| Les crochets ne fonctionnent pas | Non redémarré | Quittez et redémarrez Claude Code |
| Toutes les commandes bloquées | Modèles trop larges | Modifier YAML, rendre les modèles spécifiques |
| Commande valide bloquée | Faux positif | Déplacez-vous vers AskPatterns ou supprimez |
| Fichier de modèles manquant | Non créé | Exécutez `/agileflow:configure damagecontrol` |
| Erreur d'analyse JSON | Paramètres invalides | Validez avec `jq empty .claude/settings.json` |

### Désactivation**Désactiver temporairement :**
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
# Restart Claude Code
```

**Supprimer le crochet spécifique :**
```bash
jq 'del(.hooks.PreToolUse)' .claude/settings.json > tmp.json
mv tmp.json .claude/settings.json
# Restart Claude Code
```

**Réactiver :**
```bash
/agileflow:configure damagecontrol
# Restart Claude Code
```

---

## meilleures pratiques

### À faire
- Activer le contrôle des dommages sur tous les projets
- Utiliser la protection standard (l'amélioration est expérimentale)
- Testez avec `rm -rf /` après l'installation
- Conserver le fichier de modèles dans le contrôle de version
- Examiner les opérations bloquées dans les journaux

### À ne pas faire
- Ne désactivez pas sans raison valable
- Ne créez pas de modèles trop larges (faux positifs)
- N'oubliez pas de redémarrer après les modifications
- N'ignorez pas les avertissements de commandes bloquées

### Pour les équipes
- Valider `.agileflow/config/damage-control-patterns.yaml`
- Documenter les modèles personnalisés avec des commentaires
- Tester les modèles avant de les déployer dans l'équipe
- Réviser et mettre à jour les modèles périodiquement