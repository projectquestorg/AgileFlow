---
title: Modo de bucle
description: Procesamiento autónomo de historias con Ralph Loop para una finalización épica sin intervención
---
# Modo bucle

El modo Loop permite el procesamiento autónomo de historias a través del sistema **Ralph Loop** de AgileFlow. Lleva el nombre del patrón "Ralph Wiggum" de la investigación de Anthropic sobre flujos de trabajo agentes y procesa automáticamente historias en una epopeya sin intervención manual.

El Modo Bucle se activa mediante el comando [`/agileflow:babysit`](/commands/babysit) con parámetros especiales. Babysit organiza todo el proceso mientras Ralph Loop se encarga de la automatización.

## Descripción general

Cuando está habilitado, modo bucle:

1. Elige la primera historia "lista" de una epopeya.
2. Lo marca como "in_progress" y comienza la implementación.
3. Cuando Claude se detiene, ejecuta las pruebas automáticamente.
4. Si las pruebas pasan → marca la historia como completa, carga la siguiente historia
5. Continúa hasta que se complete la épica o se alcancen las iteraciones máximas.

Esto permite el **procesamiento por lotes nocturno** de epopeyas bien definidas con criterios de aceptación claros.

## Inicio rápido

```bash
# Start loop mode for an epic
/agileflow:babysit EPIC=EP-0042 MODE=loop

# Or initialize directly via script
node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042 --max=20
```

## Cómo funciona

### El gancho de parada

El modo Loop utiliza el sistema de gancho de parada de Claude Code. Cuando Claude deja de responderng:

1. El script `ralph-loop.js` se ejecuta automáticamente
2. Ejecuta el comando de prueba configurado (predeterminado: `npm test`)
3. Según los resultados, avanza a la siguiente historia o solicita correcciones.

<imagen>
  <source media="(prefiere-color-scheme: oscuro)" srcset="/images/docs/features/loop-mode-flow.dark.svg" />
  <img alt="Flujo en modo bucle" src="/images/docs/features/loop-mode-flow.light.svg" />
</imagen>

### Estado de sesión

La configuración del bucle se almacena en `docs/09-agents/session-state.json`:

```json
{
  "ralph_loop": {
    "enabled": true,
    "epic": "EP-0042",
    "current_story": "US-0015",
    "iteration": 3,
    "max_iterations": 20,
    "test_command": "npm test",
    "mode": "normal"
  }
}
```

## Parámetros

| Parámetro | Requerido | Predeterminado | Descripción |
|-----------|----------|---------|-------------|
| `EPIC` | Sí | - | ID de Epic para procesar (por ejemplo, EP-0042) |
| `MODE` | Sí | - | Debe ser `loop` para el modo autónomo |
| `MAX` | No | 20 | Iteraciones máximas antes de detenerse |

## Comandos CLI

```bash
# Initialize loop for an epic
node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042 --max=20

# Check current loop status
node .agileflow/scripts/ralph-loop.js --status

# Stop the loop gracefully
node .agileflow/scripts/ralph-loop.js --stop

# Reset loop state completely
node .agileflow/scripts/ralph-loop.js --reset

# Run one iteration manually
node .agileflow/scripts/ralph-loop.js --run
```

## Modos de bucle

### Modo normal (predeterminado)

Verificación estándar basada en pruebas:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop
```

- Ejecuta `npm test` después de cada parada de Claude
- Pasa si todas las pruebas tienen éxito
- Falla si falla alguna prueba

### Modo visual

Para epopeyas centradas en la interfaz de usuario que requieren verificación de captura de pantalla:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop VISUAL=true
```

- Comprueba el directorio `screenshots/` en busca de imágenes.
- Todas las capturas de pantalla deben tener el prefijo `verified-`
- Útil para el desarrollo de componentes de UI

Consulte [Modo visual](/features/visual-mode) para obtener más detalles.

### Modo de cobertura

Para requisitos de cobertura de prueba:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop COVERAGE=80
```

- Ejecuta pruebas con informes de cobertura.
- Verifica que la cobertura cumpla con el umbral (por ejemplo, 80%)
- Falla si la cobertura cae por debajo del umbral

## Selección de historia

El modo bucle selecciona historias en este orden de prioridad:

1. **Historia actual** - Si ya hay una en progreso
2. **Historias listas** - Historias con estado "listas" (se cumplieron todas las dependencias)
3. **Historias bloqueadas** - Se omite hasta que se desbloquea

Las historias deben tener:
- Criterios de aceptación claros
- Todas las dependencias resueltas.
- Estado establecido en "listo" o "pendiente"

## Configuración

### Comando de prueba

Configure el comando de prueba en __NOTRADUCIR_32__:

```json
{
  "loop": {
    "test_command": "npm test",
    "coverage_threshold": 70,
    "max_iterations": 20
  }
}
```

### Configuración del gancho de parada

El modo bucle requiere el gancho de parada en `.claude/settings.json`:

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "node .agileflow/scripts/ralph-loop.js --run"
          }
        ]
      }
    ]
  }
}
```

## Cuándo utilizar el modo bucle

### Bueno para

- ✅ Épicas bien definidas con historias claras.
- ✅ Desarrollo basado en pruebas (las pruebas definen "hecho")
- ✅ Procesamiento por lotes de varias historias durante la noche
- ✅ Tareas de implementación repetitivas (puntos finales CRUD, componentes)
- ✅ Historias con criterios de aceptación automatizados

### No es bueno para

- ❌ Trabajo exploratorio sin criterios de aceptación claros
- ❌ Historias que requieren revisión humana antes de continuar
- ❌ Trabajo multidominio complejo que necesita coordinación
- ❌ Implementaciones por primera vez sin patrones
- ❌ Historias con dependencias externas (API, servicios)

## Ejemplo de flujo de trabajo

### 1. Prepara la epopeya

Asegúrese de que todas las historias tengan criterios de aceptación claros:

```markdown
## US-0015: Add User List Component

**Acceptance Criteria:**
- [ ] Component renders list of users from API
- [ ] Loading state shown while fetching
- [ ] Error state displayed on failure
- [ ] Empty state when no users

**Tests:** src/components/UserList.test.tsx
```

### 2. Iniciar el modo de bucle

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop MAX=15
```

### 3. Monitorear el progreso

Verifique el estado periódicamente:

```bash
node .agileflow/scripts/ralph-loop.js --status
```

Salida:
```
Loop Status:
  Epic: EP-0042
  Current Story: US-0017
  Iteration: 5 of 15
  Mode: normal
  Stories Completed: 4
  Stories Remaining: 3
```

### 4. Manejar las fallas

si pruebaSi falla, el modo Loop muestra las fallas y continúa funcionando:

```
❌ Tests failed for US-0017

Failures:
  - UserList.test.tsx: Expected 3 users, got 2

Continue fixing or run /agileflow:babysit --stop to pause.
```

### 5. Completa la épica

Cuando todas las historias estén completas:

```
✅ Epic EP-0042 Complete!

Summary:
  - Stories Completed: 7
  - Total Iterations: 12
  - Time Elapsed: 2h 34m

All tests passing. Ready for review.
```

## Solución de problemas

### El bucle no se inicia

1. Verifique que exista el estado de la sesión:
   ```bash
   cat docs/09-agents/session-state.json
   ```

2. Verifique que el gancho de tope esté configurado:
   ```bash
   cat .claude/settings.json | grep -A5 "Stop"
   ```

3. Inicializar manualmente:
   ```bash
   node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042
   ```

### Las pruebas siempre fallan

1. Primero ejecute las pruebas manualmente:
   ```bash
   npm test
   ```

2. Verifique el comando de prueba en la configuración:
   ```bash
   cat docs/00-meta/agileflow-metadata.json | grep test_command
   ```

3. Asegúrese de que existan pruebas para la historia actual.

### Bucle atascado en la misma historia

1. Verifique el recuento de iteraciones:
   ```bash
   node .agileflow/scripts/ralph-loop.js --status
   ```

2. Si se acerca a las iteraciones máximas, ya sea:
   - Solucionar el problema de bloqueo.
   - Saltar la historia: actualizar el estado a "bloqueado"
   - Incremento máximo: `--max=30`

### Detenerse inesperadamente

El bucle se detiene cuando:
- Iteraciones máximas alcanzadas
- Épica completa
- Comando de parada manual
- Error crítico en la ejecución de la prueba.

Consulte los registros para obtener más detalles:
```bash
cat .agileflow/logs/ralph-loop.log
```

## Mejores prácticas

### 1. Comience con un episodio pequeñocircuitos integrados

Pruebe primero el modo bucle en una historia épica de 3 a 5 historias antes de lotes más grandes.

### 2. Escriba las pruebas primero

El modo de bucle funciona mejor con TDD: las pruebas definen cuándo se "termina" una historia.

### 3. Mantenga las historias enfocadas

Cada historia debe poder completarse en 1 a 3 iteraciones. Grandes historias → más fracasos.

### 4. Monitorear periódicamente

Verifique el estado cada 30 a 60 minutos durante carreras largas.

### 5. Utilice el modo visual para la interfaz de usuario

Para el trabajo de la interfaz de usuario, habilite el modo visual para detectar problemas de renderizado que las pruebas puedan pasar por alto.

## Funciones relacionadas

- [Modo visual](/features/visual-mode) - Verificación de captura de pantalla para el desarrollo de la interfaz de usuario
- [Contexto compacto](/features/compact-context) - Preservación del contexto durante sesiones largas
- [`/agileflow:babysit`](/commands/babysit) - El comando mentor que organiza el modo Loop
- [`/agileflow:verify`](/commands/verify) - Verificación de prueba manual

## Arquitectura

El modo bucle consta de:

| Componente | Propósito |
|-----------|------------------|
| `ralph-loop.js` | Guión de orquestación del bucle principal |
| `screenshot-verifier.js` | Comprobación de captura de pantalla en modo visualrey |
| `session-state.json` | Configuración y estado del bucle |
| Gancho de tope | Punto de integración del Código Claude |

El nombre "Ralph" proviene del trabajo de investigación de Anthropic sobre flujos de trabajo agentes, donde se utilizó "Ralph Wiggum" como nombre en clave para patrones de finalización de tareas autónomas.