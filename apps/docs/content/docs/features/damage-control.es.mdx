---
title: Control de daños
description: Proteja su base de código de comandos destructivos usando ganchos PreToolUse
---
# Control de daños

Damage Control es un sistema de seguridad que evita que los agentes de IA ejecuten comandos destructivos o peligrosos. Utiliza los **ganchos PreToolUse** de Claude Code para validar los comandos antes de su ejecución.

## Inicio rápido

```bash
# Enable with interactive wizard
/agileflow:configure damagecontrol

# Or command line
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol

# Then restart Claude Code (Cmd+Q / Ctrl+Q)
```

## Cómo funciona

<imagen>
  <fuente media="(prefiere-color-scheme: oscuro)" srcset="/images/docs/features/damage-control-flow.dark.svg" />
  <img alt="Flujo de control de daños" src="/images/docs/features/damage-control-flow.light.svg" />
</imagen>

Damage Control utiliza tres ganchos separados:

| Gancho | Archivo | Protege contra |
|------|------|------------------|
| **Golpe** | `damage-control-bash.js` | Comandos de shell peligrosos |
| **Editar** | `damage-control-edit.js` | Ediciones a archivos protegidos |
| **Escribir** | `damage-control-write.js` | Escribe en ubicaciones protegidas |

---

## Capas de protección

### Patrones de comando Bash

**Bloqueado automáticamente:**
- Eliminaciones destructivas: `rm -rf /`, `rm -rf ..`, eliminaciones recursivas
- Empuje forzado: `git push --force`, `git push -f`
- Restablecimiento completo: `git reset --hard`
- Destrucción de base de datos: `DROP TABLE`, `TRUNCATE TABLE`, `DELETE FROM ... ;`
- Operaciones de disco: `dd if=`, `mkfs.`, `fdisk`
- Exposición de credenciales: `cat *.pem`, `cat id_rsa`
- Forzar muerte: `kill -9`, `killall`, `pkill -9`
- Y más de 30 patrones más

**Requiere Confirmación (Preguntar Patrones):**
- Eliminación de bases de datos con DONDE: `DELETE FROM table WHERE ...`
- Publicación: `npm publish`
- Empujando a principal: `git push origin main`
- Eliminaciones de Cloud CLI: `aws delete`, `gcloud delete`, `az delete`
- Actualizaciones de la base de datos: `UPDATE ... SET ... WHERE`
- Eliminando node_modules: `rm -rf node_modules`

### Niveles de protección de ruta

| Nivel | Leer | Escribir | Editar | Eliminar |
|-------|------|-------|------|--------|
| **Acceso cero** | No | No | No | No |
| **Solo lectura** | Sí | No | No | No |
| **Sin eliminar** | Sí | Sí | Sí | No |

**Rutas de acceso cero:**
- Claves SSH: `~/.ssh/`, `id_rsa`, `id_ed25519`
- Credenciales de la nube: `~/.aws/`, `~/.gnupg/`, `~/.config/gh/`
- Secretos de producción: `.env.production`, `.env.local`, `.env.secrets`
- Claves privadas: `*.pem`, `*.key`, `credentials.json`

**Rutas de solo lectura:**
- Configuración de Shell: `~/.bashrc`, `~/.zshrc`, `~/.gitconfig`
- Bloquear archivos: `package-lock.json`, `yarn.lock`
- Sistema: `/etc/`

**No eliminar rutas:**
- Núcleo de AgileFlow: `.agileflow/`, `.claude/`
- Estado del proyecto: `docs/09-agents/status.json`
- Control de fuente: `.git/`
- Raíces del proyecto: `README.md`, `package.json`

---

## Guía de configuración

### Requisitos previos

- ÁgilFlow v2.78.0+
- Código Claude (más reciente)
- Directorio `.agileflow` instalado

### Paso 1: Elija el nivel de protección

**Estándar (Recomendado)**
- Sólo coincidencia rápida de patrones
- Se agregó latencia de 0 ms
- Más de 40 patrones peligrosos bloqueados
- Perfecto para la mayoría de los proyectos

**Mejorado**
- Evaluación estándar + IA para amenazas desconocidas
-Se agregó una latencia de 50-100 ms
- Mejor para código altamente sensible
- Característica experimental

**Mínimo**
- Sólo protección de camino
- No hay patrones de comando bash

### Paso 2: Habilitar

```bash
/agileflow:configure damagecontrol
```

O:

```bash
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol
```

### Paso 3: Verificar

```bash
# Check patterns file
ls -la .agileflow/config/damage-control-patterns.yaml

# Check hooks configured
grep -A 5 "PreToolUse" .claude/settings.json

# Test (should be blocked)
rm -rf /
```

### Paso 4: reiniciar Claude Code

**Importante:** Los enlaces solo surten efecto después del reinicio.

```bash
# Complete quit (Cmd+Q / Ctrl+Q)
# Wait 5 seconds
# Reopen Claude Code
```

---

## Arquitectura

### Flujo del sistema

<imagen>
  <fuente media="(prefiere-color-esquema: oscuro)" srcset="/images/docs/features/damage-control-arch.dark.svg" />
  <img alt="Arquitectura de control de daños" src="/images/docs/features/damage-control-arch.light.svg" />
</imagen>

### Ejemplo de gancho Bash

```javascript
// Input: { command: "rm -rf /" }
// Pattern: /\brm\s+-rf\s+/
// Test: pattern.test("rm -rf /") = true
// Result: BLOCKED (exit code 2)
```

### Editar ejemplo de gancho

```javascript
// Input: { file_path: "/Users/me/.ssh/id_rsa" }
// Protected: zeroAccessPaths: ["~/.ssh/"]
// Test: path.startsWith(expandedPath)
// Result: BLOCKED (exit code 2)
```

### Códigos de salida

| Código | Significado | Acción |
|------|---------|--------|
| 0 | Permitir | La herramienta se ejecuta normalmente |
| 2 | Bloquear | Ejecución de herramienta impedida |

### Filosofía de apertura fallida

Si el archivo de patrones está dañado o falta, los comandos están **permitidos** (no bloqueados). Esto asegura una sa rotaEl sistema de seguridad no bloquea todas las operaciones.

---

## Configuración

### Archivo de patrones

Ubicación: `.agileflow/config/damage-control-patterns.yaml`

```yaml
# Blocked bash commands
bashToolPatterns:
  - pattern: 'rm\s+-rf\s+/'
    reason: "Recursive delete from root"
  - pattern: 'git\s+push\s+--force'
    reason: "Force push blocked"

# Requires confirmation
askPatterns:
  - pattern: 'npm\s+publish'
    reason: "Publishing to npm"
  - pattern: 'git\s+push\s+origin\s+main'
    reason: "Pushing to main"

# Zero access (no read/write/edit)
zeroAccessPaths:
  - '~/.ssh/'
  - '.env'

# Read-only (can read, not modify)
readOnlyPaths:
  - '~/.bashrc'
  - 'package-lock.json'

# No delete (can read/write, not delete)
noDeletePaths:
  - '.agileflow/'
  - '.git/'
```

### Agregar patrones personalizados

Edite el archivo de patrones directamente:

```yaml
# Add to bashToolPatterns
bashToolPatterns:
  # ... existing patterns ...
  - pattern: 'my-dangerous-command'
    reason: "Custom block reason"

# Add to askPatterns
askPatterns:
  # ... existing patterns ...
  - pattern: 'deploy\s+production'
    reason: "Production deployment"
```

### Configuración de ganchos

En `.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-bash.js"
        }]
      },
      {
        "matcher": "Edit",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-edit.js"
        }]
      },
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-write.js"
        }]
      }
    ]
  }
}
```

---

## Preguntas frecuentes y solución de problemas

### Preguntas generales

**P: ¿El control de daños ralentiza los comandos?**

R: No, agrega menos de 5 ms por comando. La coincidencia de patrones está optimizada.

**P: ¿Puedo desactivarlo temporalmente?**

R: Sí:
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
```
Luego reinicie Claude Code. Vuelva a habilitar con `--enable=damagecontrol`.

**P: ¿Qué pasa si bloquea algo que debería estar permitido?**

R: Editar `.agileflow/config/damage-control-patterns.yaml`:
1. Haz que el patrón sea más específico
2. Muévalo de `bashToolPatterns` a `askPatterns`
3. Quítelo si no es necesario

Luego reinicie Claude Code.

**P: ¿También protege contra errores humanos?**

R: Sí. Todos los comandos pasan por ganchos, ya sean tuyos o de la IA.

**P: ¿Se pueden omitir los patrones?**

R: No es fácil. Los patrones coincidencadenas de comando reales. Soluciones simples como `r m -rf` crean errores de sintaxis.

### Problemas de configuración

**P: Los ganchos no funcionan después de habilitarlos.**

R: Causa más común: no has reiniciado Claude Code:
1. Cerrar completamente (Cmd+Q / Ctrl+Q)
2. Espere 5 segundos
3. Reabrir
4. Pruebe con `rm -rf /`

**P: ¿Cómo sé si está funcionando?**

R: Pruebe un comando bloqueado:
```bash
rm -rf /
# Should see: [BLOCKED] rm with absolute path
```

**P: No puedo encontrar el archivo de patrones.**

R: Créelo:
```bash
mkdir -p .agileflow/config
cp .agileflow/templates/damage-control-patterns.yaml .agileflow/config/
```

**P: settings.json se corrompió.**

R: Arreglarlo:
```bash
cp .claude/settings.json .claude/settings.json.broken
node .agileflow/scripts/agileflow-configure.js --migrate
# If that fails:
rm .claude/settings.json
/agileflow:configure damagecontrol
```

### Matriz de resolución de problemas

| Problema | Causa | Solución |
|---------|-------|----------|
| Los ganchos no funcionan | No reiniciado | Salga y reinicie Claude Code |
| Todos los comandos bloqueados | Patrones demasiado amplios | Edite YAML, haga patrones específicos |
| Comando válido bloqueado | Falso positivo | Mover a AskPatterns o eliminar |
| Falta el archivo de patrones | No creado | Ejecute `/agileflow:configure damagecontrol` |
| Error de análisis JSON | Configuraciones no válidas | Validar con `jq empty .claude/settings.json` |

### Deshabilitar**Desactivar temporalmente:**
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
# Restart Claude Code
```

**Eliminar gancho específico:**
```bash
jq 'del(.hooks.PreToolUse)' .claude/settings.json > tmp.json
mv tmp.json .claude/settings.json
# Restart Claude Code
```

**Reactivar:**
```bash
/agileflow:configure damagecontrol
# Restart Claude Code
```

---

## Mejores prácticas

### Qué hacer
- Habilitar el control de daños en todos los proyectos.
- Utilice protección estándar (la mejorada es experimental)
- Pruebe con `rm -rf /` después de la configuración
- Mantener el archivo de patrones en el control de versiones.
- Revisar operaciones bloqueadas en registros.

### Lo que no se debe hacer
- No desactives sin una buena razón
- No hagas patrones demasiado amplios (falsos positivos)
- No olvides reiniciar después de los cambios.
- No ignores las advertencias de comandos bloqueados

### Para equipos
- Confirmar `.agileflow/config/damage-control-patterns.yaml`
- Documentar patrones personalizados con comentarios.
- Patrones de prueba antes de implementarlos en el equipo.
- Revisar y actualizar patrones periódicamente.