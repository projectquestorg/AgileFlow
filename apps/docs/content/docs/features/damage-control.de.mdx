---
title: Schadensbegrenzung
description: Schützen Sie Ihre Codebasis mit PreToolUse-Hooks vor zerstörerischen Befehlen
---
# Schadensbegrenzung

Damage Control ist ein Sicherheitssystem, das verhindert, dass KI-Agenten destruktive oder gefährliche Befehle ausführen. Es verwendet die **PreToolUse-Hooks** von Claude Code, um Befehle vor der Ausführung zu validieren.

## Schnellstart

```bash
# Enable with interactive wizard
/agileflow:configure damagecontrol

# Or command line
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol

# Then restart Claude Code (Cmd+Q / Ctrl+Q)
```

## Wie es funktioniert

<Bild>
  <source media="(prefers-color-scheme: dark)" srcset="/images/docs/features/damage-control-flow.dark.svg" />
  <img alt="Damage Control Flow" src="/images/docs/features/damage-control-flow.light.svg" />
</Bild>

Damage Control verwendet drei separate Hooks:

| Haken | Datei | Schützt vor |
|------|------|----|
| **Bash** | `damage-control-bash.js` | Gefährliche Shell-Befehle |
| **Bearbeiten** | `damage-control-edit.js` | Änderungen an geschützten Dateien |
| **Schreiben** | `damage-control-write.js` | Schreibt an geschützte Speicherorte |

---

## Schutzschichten

### Bash-Befehlsmuster

**Automatisch blockiert:**
- Destruktive Löschungen: `rm -rf /`, `rm -rf ..`, rekursive Löschungen
- Push erzwingen: `git push --force`, `git push -f`
- Hard-Reset: `git reset --hard`
- Datenbankzerstörung: `DROP TABLE`, `TRUNCATE TABLE`, `DELETE FROM ... ;`
- Festplattenoperationen: `dd if=`, `mkfs.`, `fdisk`
- Offenlegung der Anmeldeinformationen: `cat *.pem`, `cat id_rsa`
- Kill erzwingen: `kill -9`, `killall`, `pkill -9`
- Und über 30 weitere Muster

**Bestätigung erforderlich (Ask Patterns):**
- Datenbank löscht mit WHERE: `DELETE FROM table WHERE ...`
- Veröffentlichung: `npm publish`
- Zur Hauptseite schieben: `git push origin main`
– Cloud CLI löscht: `aws delete`, `gcloud delete`, `az delete`
- Datenbankaktualisierungen: `UPDATE ... SET ... WHERE`
– Entfernen von node_modules: `rm -rf node_modules`

### Pfadschutzstufen

| Ebene | Lesen | Schreiben | Bearbeiten | Löschen |
|-------|------|-------|------|--------|
| **Kein Zugriff** | Nein | Nein | Nein | Nein |
| **Read-Only** | Ja | Nein | Nein | Nein |
| **Kein Löschen** | Ja | Ja | Ja | Nein |

**Keine Zugriffspfade:**
- SSH-Schlüssel: `~/.ssh/`, `id_rsa`, `id_ed25519`
- Cloud-Anmeldeinformationen: `~/.aws/`, `~/.gnupg/`, `~/.config/gh/`
- Produktionsgeheimnisse: `.env.production`, `.env.local`, `.env.secrets`
- Private Schlüssel: `*.pem`, `*.key`, `credentials.json`

**Schreibgeschützte Pfade:**
- Shell-Konfiguration: `~/.bashrc`, `~/.zshrc`, `~/.gitconfig`
- Dateien sperren: `package-lock.json`, `yarn.lock`
- System: `/etc/`

**Keine Löschpfade:**
- AgileFlow-Kern: `.agileflow/`, `.claude/`
- Projektstatus: `docs/09-agents/status.json`
- Quellcodeverwaltung: `.git/`
- Projektwurzeln: `README.md`, `package.json`

---

## Einrichtungsanleitung

### Voraussetzungen

- AgileFlow v2.78.0+
- Claude Code (neueste)
- Verzeichnis `.agileflow` installiert

### Schritt 1: Wählen Sie die Schutzstufe

**Standard (empfohlen)**
- Nur schneller Mustervergleich
- 0 ms Latenz hinzugefügt
- Über 40 gefährliche Muster blockiert
- Perfekt für die meisten Projekte

**Erweitert**
- Standard- und KI-Bewertung für unbekannte Bedrohungen
-50-100 ms Latenz hinzugefügt
– Besser für hochsensiblen Code
- Experimentelle Funktion

**Minimal**
- Nur Pfadschutz
- Keine Bash-Befehlsmuster

### Schritt 2: Aktivieren

```bash
/agileflow:configure damagecontrol
```

Oder:

```bash
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol
```

### Schritt 3: Überprüfen

```bash
# Check patterns file
ls -la .agileflow/config/damage-control-patterns.yaml

# Check hooks configured
grep -A 5 "PreToolUse" .claude/settings.json

# Test (should be blocked)
rm -rf /
```

### Schritt 4: Starten Sie Claude Code neu

**Wichtig:** Hooks werden erst nach dem Neustart wirksam.

```bash
# Complete quit (Cmd+Q / Ctrl+Q)
# Wait 5 seconds
# Reopen Claude Code
```

---

## Architektur

### Systemfluss

<Bild>
  <source media="(prefers-color-scheme: dark)" srcset="/images/docs/features/damage-control-arch.dark.svg" />
  <img alt="Damage Control Architecture" src="/images/docs/features/damage-control-arch.light.svg" />
</Bild>

### Bash-Hook-Beispiel

```javascript
// Input: { command: "rm -rf /" }
// Pattern: /\brm\s+-rf\s+/
// Test: pattern.test("rm -rf /") = true
// Result: BLOCKED (exit code 2)
```

### Hook-Beispiel bearbeiten

```javascript
// Input: { file_path: "/Users/me/.ssh/id_rsa" }
// Protected: zeroAccessPaths: ["~/.ssh/"]
// Test: path.startsWith(expandedPath)
// Result: BLOCKED (exit code 2)
```

### Exit-Codes

| Code | Bedeutung | Aktion |
|------|---------|--------|
| 0 | Erlauben | Tool wird normal ausgeführt |
| 2 | Blockieren | Werkzeugausführung verhindert |

### Fail-Open-Philosophie

Wenn die Musterdatei beschädigt ist oder fehlt, sind Befehle **erlaubt** (nicht blockiert). Dies sorgt für eine kaputte SaDas Fety-System blockiert nicht alle Vorgänge.

---

## Konfiguration

### Musterdatei

Standort: `.agileflow/config/damage-control-patterns.yaml`

```yaml
# Blocked bash commands
bashToolPatterns:
  - pattern: 'rm\s+-rf\s+/'
    reason: "Recursive delete from root"
  - pattern: 'git\s+push\s+--force'
    reason: "Force push blocked"

# Requires confirmation
askPatterns:
  - pattern: 'npm\s+publish'
    reason: "Publishing to npm"
  - pattern: 'git\s+push\s+origin\s+main'
    reason: "Pushing to main"

# Zero access (no read/write/edit)
zeroAccessPaths:
  - '~/.ssh/'
  - '.env'

# Read-only (can read, not modify)
readOnlyPaths:
  - '~/.bashrc'
  - 'package-lock.json'

# No delete (can read/write, not delete)
noDeletePaths:
  - '.agileflow/'
  - '.git/'
```

### Benutzerdefinierte Muster hinzufügen

Bearbeiten Sie die Musterdatei direkt:

```yaml
# Add to bashToolPatterns
bashToolPatterns:
  # ... existing patterns ...
  - pattern: 'my-dangerous-command'
    reason: "Custom block reason"

# Add to askPatterns
askPatterns:
  # ... existing patterns ...
  - pattern: 'deploy\s+production'
    reason: "Production deployment"
```

### Hooks-Konfiguration

In `.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-bash.js"
        }]
      },
      {
        "matcher": "Edit",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-edit.js"
        }]
      },
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "node .agileflow/scripts/damage-control-write.js"
        }]
      }
    ]
  }
}
```

---

## FAQ und Fehlerbehebung

### Allgemeine Fragen

**F: Verlangsamt Damage Control Befehle?**

A: Nein, es kommen weniger als 5 ms pro Befehl hinzu. Der Mustervergleich ist optimiert.

**F: Kann ich es vorübergehend deaktivieren?**

A: Ja:
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
```
Starten Sie dann Claude Code neu. Mit `--enable=damagecontrol` erneut aktivieren.

**F: Was passiert, wenn dadurch etwas blockiert wird, das erlaubt sein sollte?**

A: Bearbeiten Sie `.agileflow/config/damage-control-patterns.yaml`:
1. Machen Sie das Muster spezifischer
2. Verschieben Sie es von `bashToolPatterns` nach `askPatterns`
3. Entfernen Sie es, wenn es nicht benötigt wird

Starten Sie dann Claude Code neu.

**F: Schützt es auch vor menschlichen Fehlern?**

A: Ja. Alle Befehle durchlaufen Hooks, egal ob von Ihnen oder der KI.

**F: Können Muster umgangen werden?**

A: Nicht einfach. Muster stimmen übereintatsächliche Befehlszeichenfolgen. Einfache Problemumgehungen wie `r m -rf` führen zu Syntaxfehlern.

### Setup-Probleme

**F: Hooks funktionieren nach der Aktivierung nicht.**

A: Häufigste Ursache – Sie haben Claude Code nicht neu gestartet:
1. Vollständig schließen (Befehl+Q / Strg+Q)
2. Warten Sie 5 Sekunden
3. Wieder öffnen
4. Testen Sie mit `rm -rf /`

**F: Woher weiß ich, ob es funktioniert?**

A: Testen Sie einen blockierten Befehl:
```bash
rm -rf /
# Should see: [BLOCKED] rm with absolute path
```

**F: Musterdatei kann nicht gefunden werden.**

A: Erstellen Sie es:
```bash
mkdir -p .agileflow/config
cp .agileflow/templates/damage-control-patterns.yaml .agileflow/config/
```

**F: „settings.json“ wurde beschädigt.**

A: Beheben Sie das Problem:
```bash
cp .claude/settings.json .claude/settings.json.broken
node .agileflow/scripts/agileflow-configure.js --migrate
# If that fails:
rm .claude/settings.json
/agileflow:configure damagecontrol
```

### Fehlerbehebungsmatrix

| Problem | Ursache | Lösung |
|---------|-------|----------|
| Hooks laufen nicht | Nicht neu gestartet | Beenden Sie Claude Code | und starten Sie es neu
| Alle Befehle blockiert | Muster zu breit | YAML bearbeiten, Muster spezifisch machen |
| Gültiger Befehl blockiert | Falsch positiv | Zu askPatterns wechseln oder | entfernen
| Musterdatei fehlt | Nicht erstellt | Führen Sie `/agileflow:configure damagecontrol` | aus
| JSON-Analysefehler | Ungültige Einstellungen | Validieren mit `jq empty .claude/settings.json` |

### Deaktivieren
**Temporarily disable:**
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
# Restart Claude Code
```

**Remove specific hook:**
```bash
jq 'del(.hooks.PreToolUse)' .claude/settings.json > tmp.json
mv tmp.json .claude/settings.json
# Restart Claude Code
```

**Re-enable:**
```bash
/agileflow:configure damagecontrol
# Restart Claude Code
```

---

## Best Practices

### Do's
- Enable Damage Control on all projects
- Use Standard protection (Enhanced is experimental)
- Test with `rm -rf /` after setup
- Keep patterns file in version control
- Review blocked operations in logs

### Don'ts
- Don't disable without good reason
- Don't make patterns too broad (false positives)
- Don't forget to restart after changes
- Don't ignore blocked command warnings

### For Teams
- Commit `.agileflow/config/damage-control-patterns.yaml`
- Document custom patterns with comments
- Test patterns before deploying to team
- Review and update patterns periodically
