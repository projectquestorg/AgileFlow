---
title: Modo Loop
description: Processamento autônomo de histórias com Ralph Loop para uma conclusão épica sem intervenção
---

# Modo Loop

O Modo Loop permite o processamento autônomo de histórias por meio do AgileFlow **Ralph Loop** sistema. Nomeado em homenagem ao padrão “Ralph Wiggum” da pesquisa da Anthropic sobre fluxos de trabalho de agentes, ele processa automaticamente histórias em um épico sem intervenção manual.

O Modo Loop é ativado através do [`/agileflow:babá`](/commands/babysit) comando com parâmetros especiais. A Babysit orquestra todo o processo enquanto Ralph Loop cuida da automação.

## Visão geral

Quando ativado, Modo Loop:

1. Escolhe a primeira história "pronta" de um épico
2. Marca como "in_progress" e inicia a implementação
3. Quando Claude para, executa testes automaticamente
4. Se os testes forem aprovados → marca a história como concluída e carrega a próxima história
5. Continua até a conclusão épica ou o máximo de iterações alcançado

Isso permite **overnight batch processing** de épicos bem definidos com critérios de aceitação claros.

## Início rápido

```bash
# Start loop mode for an epic
/agileflow:babysit EPIC=EP-0042 MODE=loop

# Or initialize directly via script
node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042 --max=20
```

## Como funciona

### O gancho de parada

O Modo Loop usa o sistema de gancho de parada do Claude Code. Quando Claude para de responder:

1. O `ralph-loop.js` script é executado automaticamente
2. Ele executa o comando de teste configurado (padrão: `npm test`)
3. Com base nos resultados, ele avança para a próxima história ou solicita correções

<picture>
  <source media="(prefers-color-scheme: dark)" srcset="/images/docs/features/loop-mode-flow.dark.svg" />
  <img alt="Fluxo do modo Loop" src="/images/docs/features/loop-mode-flow.light.svg" />
</picture>

### Estado da sessão

A configuração do loop é armazenada em `docs/09-agents/session-state.json`:

```json
{
  "ralph_loop": {
    "enabled": true,
    "epic": "EP-0042",
    "current_story": "US-0015",
    "iteration": 3,
    "max_iterations": 20,
    "test_command": "npm test",
    "mode": "normal"
  }
}
```

## Parâmetros

| Parameter | Required | Default | Description |
|-----------|----------|---------|-------------|
| `EPIC` | Yes | - | Epic ID to process (e.g., EP-0042) |
| `MODE` | Yes | - | Must be `loop` for autonomous mode |
| `MAX` | No | 20 | Maximum iterations before stopping |

## Comandos CLI

```bash
# Initialize loop for an epic
node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042 --max=20

# Check current loop status
node .agileflow/scripts/ralph-loop.js --status

# Stop the loop gracefully
node .agileflow/scripts/ralph-loop.js --stop

# Reset loop state completely
node .agileflow/scripts/ralph-loop.js --reset

# Run one iteration manually
node .agileflow/scripts/ralph-loop.js --run
```

## Modos de loop

### Modo normal (padrão)

Verificação baseada em teste padrão:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop
```

- Corre `npm test` depois de cada parada de Claude
- Aprovado se todos os testes forem bem-sucedidos
- Falha se algum teste falhar

### Modo Visual

Para épicos focados na UI que exigem verificação de captura de tela:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop VISUAL=true
```

- Cheques `screenshots/` diretório para imagens
- Todas as capturas de tela devem ter `verified-` prefixo
- Útil para desenvolvimento de componentes de UI

Ver [Modo Visual](/features/visual-mode) para obter detalhes.

### Modo de cobertura

Para requisitos de cobertura de teste:

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop COVERAGE=80
```

- Executa testes com relatórios de cobertura
- Verifica se a cobertura atende ao limite (por exemplo, 80%)
- Falha se a cobertura cair abaixo do limite

## Seleção de histórias

O Modo Loop seleciona histórias nesta ordem de prioridade:

1. **Current story** - Se um já estiver em andamento
2. **Ready stories** - Stories com status “pronto” (todas as dependências atendidas)
3. **Blocked stories** - Ignorado até ser desbloqueado

As histórias devem ter:
- Critérios de aceitação claros
- Todas as dependências resolvidas
- Status definido como "pronto" ou "pendente"

## Configuração

### Comando de teste

Configure o comando de teste em `agileflow-metadata.json`:

```json
{
  "loop": {
    "test_command": "npm test",
    "coverage_threshold": 70,
    "max_iterations": 20
  }
}
```

### Parar configuração do gancho

O Modo Loop requer o gancho de parada `.claude/settings.json`:

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "node .agileflow/scripts/ralph-loop.js --run"
          }
        ]
      }
    ]
  }
}
```

## Quando usar o modo Loop

### Bom para

- ✅ Épicos bem definidos com histórias claras
- ✅ Desenvolvimento orientado a testes (os testes definem "pronto")
- ✅ Processamento em lote de várias histórias durante a noite
- ✅ Tarefas de implementação repetitivas (endpoints CRUD, componentes)
- ✅ Histórias com critérios de aceitação automatizados

### Não é bom para

- ❌ Trabalho exploratório sem critérios de aceitação claros
- ❌ Histórias que exigem revisão humana antes de prosseguir
- ❌ Trabalho complexo em vários domínios que precisa de coordenação
- ❌ Implementações iniciais sem padrões
- ❌ Histórias com dependências externas (APIs, serviços)

## Exemplo de fluxo de trabalho

### 1. Prepare o épico

Certifique-se de que todas as histórias tenham critérios de aceitação claros:

```markdown
## US-0015: Add User List Component

**Acceptance Criteria:**
- [ ] Component renders list of users from API
- [ ] Loading state shown while fetching
- [ ] Error state displayed on failure
- [ ] Empty state when no users

**Tests:** src/components/UserList.test.tsx
```

### 2. Inicie o modo Loop

```bash
/agileflow:babysit EPIC=EP-0042 MODE=loop MAX=15
```

### 3. Monitore o progresso

Verifique o status periodicamente:

```bash
node .agileflow/scripts/ralph-loop.js --status
```

Saída:
```
Loop Status:
  Epic: EP-0042
  Current Story: US-0017
  Iteration: 5 of 15
  Mode: normal
  Stories Completed: 4
  Stories Remaining: 3
```

### 4. Lidar com falhas

Se os testes falharem, o Loop Mode mostra as falhas e continua funcionando:

```
❌ Tests failed for US-0017

Failures:
  - UserList.test.tsx: Expected 3 users, got 2

Continue fixing or run /agileflow:babysit --stop to pause.
```

### 5. Complete a Épica

Quando todas as histórias forem concluídas:

```
✅ Epic EP-0042 Complete!

Summary:
  - Stories Completed: 7
  - Total Iterations: 12
  - Time Elapsed: 2h 34m

All tests passing. Ready for review.
```

## Solução de problemas

### Loop não inicia

1. Verifique se o estado da sessão existe:
   ```bash
   cat docs/09-agents/session-state.json
   ```

2. Verifique se o gancho de parada está configurado:
   ```bash
   cat .claude/settings.json | grep -A5 "Stop"
   ```

3. Inicialize manualmente:
   ```bash
   node .agileflow/scripts/ralph-loop.js --init --epic=EP-0042
   ```

### Testes sempre falhando

1. Execute os testes manualmente primeiro:
   ```bash
   npm test
   ```

2. Check test command in config:
   ```bash
   cat docs/00-meta/agileflow-metadata.json | grep test_command
   ```

3. Certifique-se de que existam testes para a história atual

### Loop preso na mesma história

1. Verifique a contagem de iterações:
   ```bash
   node .agileflow/scripts/ralph-loop.js --status
   ```

2. Se estiver se aproximando do máximo de iterações:
   - Corrija o problema de bloqueio
   - Ignore a história: atualize o status para "bloqueado"
   - Aumentar máximo: `--max=30`

### Parando inesperadamente

O loop para quando:
- Máximo de iterações alcançado
- Épico concluído
- Comando de parada manual
- Erro crítico na execução do teste

Verifique os registros para obter detalhes:
```bash
cat .agileflow/logs/ralph-loop.log
```

## Melhores Práticas

### 1. Comece com pequenos épicos

Teste o modo Loop em um épico de 3 a 5 histórias primeiro, antes de lotes maiores.

### 2. Escreva os testes primeiro

O Modo Loop funciona melhor com TDD - os testes definem quando uma história está "pronta".

### 3. Mantenha o foco nas histórias

Cada história deve ser completada em 1-3 iterações. Grandes histórias → mais fracassos.

### 4. Monitore Periodicamente

Verifique o status a cada 30-60 minutos durante corridas longas.

### 5. Use o modo visual para UI

Para o trabalho da IU, habilite o Modo Visual para detectar problemas de renderização que os testes podem perder.

## Recursos relacionados

- [Modo Visual](/features/visual-mode) - Verificação de captura de tela para desenvolvimento de UI
- [Contexto Compacto](/features/compact-context) - Preservação do contexto durante sessões longas
- [`/agileflow:babá`](/commands/babysit) - O comando mentor que orquestra o modo Loop
- [`/agileflow:verificar`](/commands/verify) - Verificação de teste manual

## Arquitetura

O modo Loop consiste em:

| Component | Purpose |
|-----------|---------|
| `ralph-loop.js` | Main loop orchestration script |
| `screenshot-verifier.js` | Visual Mode screenshot checking |
| `session-state.json` | Loop configuration and state |
| Stop hook | Claude Code integration point |

O nome "Ralph" vem do artigo de pesquisa da Anthropic sobre fluxos de trabalho de agentes, onde "Ralph Wiggum" foi usado como codinome para padrões autônomos de conclusão de tarefas.
