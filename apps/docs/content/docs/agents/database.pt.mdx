---
title: Banco de dados
description: Especialista em banco de dados para design de esquemas, migrações, otimização de consultas e modelagem de dados.
---
# Agente de banco de dados

O agente de banco de dados (AG-DATABASE) é o seu especialista em banco de dados para projetar esquemas eficientes, escrever migrações seguras, otimizar consultas e gerenciar a integridade dos dados. Ele garante que sua camada de banco de dados tenha desempenho, manutenção e confiabilidade.

## Capacidades

- Projetar esquemas de banco de dados eficientes (tabelas, relacionamentos, restrições)
- Escreva scripts de migração reversíveis com estratégias de reversão
- Otimize consultas lentas (identifique índices ausentes, melhore a estrutura da consulta)
- Prevenir problemas de consulta N+1 e antipadrões SELECT *
- Garantir a integridade dos dados por meio de restrições e validação
- Revise as consultas da AG-API para problemas de desempenho
- Documentar modelos de dados e relacionamentos com ADRs de arquitetura
- Coordenar com AG-API o uso de ORM e padrões de consulta
- Monitorar o desempenho e a integridade do banco de dados

## Quando usar

Use o agente de banco de dados quando:

- Você precisa projetar uma nova tabela ou estrutura de relacionamento
- Você precisa criar um script de migração para alterações de esquema
- Você percebeconsultas baixas ou problemas de desempenho
- Você deseja otimizar uma consulta complexa ao banco de dados
- Você precisa adicionar índices às colunas consultadas com frequência
- Você está projetando modelos de dados para um novo recurso
- Você deseja evitar padrões de consulta N+1 antes que eles aconteçam
- Você precisa coordenar o trabalho da camada de dados com AG-API

## Como funciona

1. **Carregamento de contexto**: o agente lê expertise, CLAUDE.md e configuração do banco de dados
2. **Revisão da história**: o agente identifica requisitos e relacionamentos de dados
3. **Modo de planejamento**: o agente projeta o esquema e a estratégia de migração (para alterações de alto risco)
4. **Design de esquema**: o agente cria diagramas de relacionamento entre entidades e normaliza os dados
5. **Criação de migração**: o agente grava scripts reversíveis de ativação/desativação com testes
6. **Coordenação**: o agente compartilha o esquema com a AG-API e analisa suas consultas
7. **Otimização**: Agente adiciona índices e evita padrões de consulta N+1
8. **Verificação**: o agente executa testes para garantir que tudo passe
9. **Documentação**: Agente atualiza status.json e apptermina mensagens de ônibus

## Exemplo

```bash
# Via /babysit (recommended)
/agileflow:babysit
> "I need to design the database schema for users and posts"
```

O agente do banco de dados irá:
1. Pergunte sobre relações de dados (um usuário para muitas postagens?)
2. Projetar esquema normalizado:
   - Tabela __NOTRASLATE_5__: id, email, nome de usuário, senha_hash, criado_at, atualizado_at
   - tabela __NOTRASLATE_6__: id, user_id, título, conteúdo, criado_at, atualizado_at
   - Restrição de chave estrangeira: posts.user_id → users.id
3. Índices do plano: idx_users_email (para login), idx_posts_user_id (para consultas)
4. Crie um script de migração com operações de subida/descida
5. Coordenar com AG-API em modelos e consultas ORM
6. Teste a reversão da migração antes da conclusão

Ou gerar diretamente:

```text
Task(
  description: "Optimize slow user profile query",
  prompt: "Query is taking 2+ seconds. Need to analyze and add missing indexes.",
  subagent_type: "agileflow-database"
)
```

## Principais comportamentos

- **Nunca faça alterações sem migrações**: todas as alterações de esquema exigem scripts de migração reversíveis
- **Modo de planejamento para alterações de alto risco**: sempre usa o modo de planejamento para projetar esquema/estratégia de migração
- **Migrações reversíveis**: toda migração "up" tem uma "down" correspondente para reversão
- **Otimização de consulta**: analisa consultaspara problemas N+1, índices ausentes, SELECT * antipadrões
- **Convenções de nomenclatura**: Tabelas em minúsculas no plural (usuários, postagens), colunas snake_case (user_id,created_at)
- **Colunas obrigatórias**: cada tabela tem id,created_at, update_at (e delete_at para exclusões suaves)
- **Coordenação com AG-API**: Revisa suas consultas e uso de ORM; sugere otimizações
- **Integração do Session Harness**: verifica o status do teste antes de iniciar, exige aprovação nos testes antes da revisão
- **Documentação proativa**: cria ADRs para decisões importantes de esquema
- **Preservação de contexto**: usa compact_context (prioridade: alta) para manter o foco durante longas conversas, preservando decisões de esquema e rastreamento de otimização de desempenho por meio de compactação de contexto

## Configuração de contexto compacto

O agente de banco de dados usa compact_context de **alta prioridade** para garantir que o design do esquema e as decisões de otimização permaneçam preservadas:

```yaml
compact_context:
  priority: high
  preserve_rules:
    - "LOAD EXPERTISE FIRST: Always read packages/cli/src/core/experts/database/expertise.yaml"
    - "NEVER CHANGE SCHEMA WITHOUT MIGRATION: All changes require reversible up/down scripts"
    - "PLAN MODE FOR HIGH-RISK CHANGES: Design schema/migration strategy before implementation"
    - "VERIFY TEST BASELINE: Check test_status before starting new work"
    - "REQUIRED COLUMNS: Every table needs id, created_at, updated_at"
    - "COORDINATION WITH AG-API: Review their queries and ORM patterns"
  state_fields:
    - current_story
    - schema_changes_planned
    - migration_strategy
    - api_query_reviews
    - test_status_baseline
```

Isso garante regras críticas para o banco de dados (requisitos de migração, nomes de esquemag, colunas obrigatórias) e o estado atual (quais alterações de esquema estão planejadas, quais consultas de API precisam ser revisadas) permanecem em foco por meio da compactação de contexto.

## Ferramentas disponíveis

Este agente tem acesso a: Ler, Escrever, Editar, Bash, Glob, Grep

## Princípios de design de esquema

**Normalização**: reduza a redundância de dados e melhore a integridade dos dados

- Minimize dados duplicados
- Uma fonte de verdade por campo
- Desnormalizar somente quando as demandas de desempenho o justificarem (documentar o porquê)

**Convenções de nomenclatura**:

- Tabelas: minúsculas, plural (usuários, produtos, pedidos)
- Colunas: minúsculas, cobra_case (nome_nome, criado_em)
- Chaves estrangeiras: formato table_id (user_id, product_id)
- Índices: formato idx_table_column (idx_users_email)

**Colunas obrigatórias**:

- __NOTRASLATE_7__: Chave primária (UUID ou incremento automático)
- __NOTRASLATE_8__: Quando o registro foi criado
- __NOTRASLATE_9__: Quando o registro foi modificado pela última vez
- `deleted_at`: carimbo de data/hora de exclusão reversível (se estiver usando exclusões reversíveis)

**Relacionamentos**:

- Um para muitos: Chave estrangeira em muitas tabelas
- Muitos para muitos: Tabela de junção com duas chaves estrangeiras
- Um para um: chave estrangeira com restrição única

## Padrões de otimização de consulta

**Identificar consultas lentas**:

__NOTRADUZIR_3__

**Otimizar consultas**:

- Adicione índices em colunas consultadas com frequência (WHERE, JOIN, ORDER BY)
- Use EXPLAIN PLAN para verificar o uso do índice
- Consultas em lote (carrega vários registros em uma única consulta)
- Use CTEs/funções de janela para agregações complexas

**Problemas comuns**:

__NÃOTRADUZIR_4__

## Práticas recomendadas de migração

**Migrações Seguras**:

1. Adicione novas colunas como anuláveis (pode preencher gradualmente)
2. Crie índices antes de descartar colunas antigas
3. Teste o plano de reversão antes de implantar
4. Faça backup antes de executar a migração destrutiva
5. Execute na janela de manutenção se for possível o impacto na produção

**Migrações reversíveis**:

- Toda migração “para cima” tem uma migração “para baixo” correspondente
- Migração descendente testada antes da implantação
- Exemplo: Adicionar coluna (para cima) / Soltar coluna (para baixo)

## Coordenação com AG-API

** Esquema DesFase de ignição**:

- AG-API descreve as necessidades de dados
- AG-DATABASE projeta esquema
- Revise juntos as oportunidades de otimização

**Fase de Implementação**:

- AG-DATABASE cria script de migração
- AG-API implementa modelos ORM
- Coordenar o carregamento do relacionamento (ansioso vs preguiçoso)

**Fase de otimização de consulta**:

- AG-API desenvolve consulta
- Avaliações AG-DATABASE para N+1 e otimização
- Adicione índices conforme necessário

## Arquivos principais

- **Especialização**: `packages/cli/src/core/experts/database/expertise.yaml` (memória do agente)
- **Fluxo de trabalho**: __NOTRASLATE_12__ (Plano → Construir → Autoaperfeiçoamento)
- **Status**: `docs/09-agents/status.json` (rastreamento de história)
- **Ônibus**: __NOTRASLATE_14__ (mensagens de coordenação)
- **CLAUDE.md**: tipo de banco de dados e informações ORM
- **Pesquisa**: __NOTRASLATE_15__ (verifique padrões de design de esquema)
- **ADRs**: __NOTRASLATE_16__ (decisões de arquitetura de banco de dados)

## Etapas do fluxo de trabalho

1. **Carregar experiência**: Leia expertise.yaml para carregar dados de esquema
2. **Revisar história**: identificar requisitos e relacionamentos de dados
3. **Entre no modo de plano**: Desquema de design, estratégia de migração, análise de impacto
4. **Criar esquema**: Definir tabelas, colunas, restrições, relacionamentos
5. **Criar migração**: Escreva scripts reversíveis para cima/para baixo
6. **Status da atualização**: marque "em andamento"
7. **Anexar mensagem de barramento**: Coordenar com AG-API
8. **Migração de teste**: teste operações de ativação e desativação
9. **Otimizar**: Adicione índices com base em padrões de consulta
10. **Verificar**: execute testes para garantir a aprovação da linha de base
11. **Marcar em revisão**: atualize o status somente quando test_status==passando
12. **Self-Improve**: Execute self-improve.md após a conclusão

## Lista de verificação de qualidade

Antes de marcar em revisão:

- [] O esquema segue as convenções de nomenclatura
- [] Todas as colunas obrigatórias presentes (id,created_at, Updated_at)
- [ ] Relacionamentos devidamente definidos (chaves estrangeiras, restrições)
- [] As migrações são reversíveis
- [] Migrações testadas (para cima e para baixo)
- [] Índices em colunas comumente consultadas
- [ ] Nenhum padrão de consulta N+1 previsto
- [] Restrições de integridade de dados aplicadas
- [] Comentários explicam o complexo ddecisões
- [] Procedimento de backup e recuperação documentado
- [] Status do teste: aprovado (verificado via /agileflow:verify)

## Agentes Relacionados

- [__NOTRASLATE_17____NOTRASLATE_20__ - Implementa modelos ORM e consultas com base no esquema
- [`mentor`](/agents/mentor) - Orquestra o trabalho do banco de dados como parte da implementação de recursos
- [__NOTRASLATE_19__](/agents/ci) - Configura bancos de dados de teste e infraestrutura de teste de migração