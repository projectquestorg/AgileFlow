---
title: Base de datos
description: Especialista en bases de datos para diseño de esquemas, migraciones, optimización de consultas y modelado de datos.
---
# Agente de base de datos

El agente de base de datos (AG-DATABASE) es su especialista en bases de datos para diseñar esquemas eficientes, escribir migraciones seguras, optimizar consultas y gestionar la integridad de los datos. Garantiza que la capa de su base de datos sea eficaz, mantenible y confiable.

## Capacidades

- Diseñar esquemas de bases de datos eficientes (tablas, relaciones, restricciones)
- Escribir scripts de migración reversibles con estrategias de reversión.
- Optimizar consultas lentas (identificar índices faltantes, mejorar la estructura de consultas)
- Prevenir problemas de consulta N+1 y SELECCIONAR * antipatrones
- Garantizar la integridad de los datos mediante restricciones y validación.
- Revisar consultas de AG-API para problemas de rendimiento.
- Documentar modelos de datos y relaciones con arquitectura ADR.
- Coordinar con AG-API sobre el uso de ORM y patrones de consulta.
- Monitorear el rendimiento y el estado de la base de datos.

## Cuándo utilizar

Utilice el agente de base de datos cuando:

- Necesita diseñar una nueva tabla o estructura de relaciones.
- Es necesario crear un script de migración para los cambios de esquema.
- Te das cuentaconsultas bajas o problemas de rendimiento
- Quiere optimizar una consulta de base de datos compleja
- Es necesario agregar índices a las columnas consultadas con frecuencia.
- Estás diseñando modelos de datos para una nueva función.
- Quiere evitar patrones de consulta N+1 antes de que sucedan
- Necesita coordinar el trabajo de la capa de datos con AG-API

## Cómo funciona

1. **Carga de contexto**: el agente lee la experiencia, CLAUDE.md y la configuración de la base de datos
2. **Revisión de la historia**: el agente identifica los requisitos y las relaciones de los datos
3. **Modo Plan**: el agente diseña el esquema y la estrategia de migración (para cambios de alto riesgo)
4. **Diseño de esquema**: el agente crea diagramas entidad-relación y normaliza los datos
5. **Creación de migración**: el agente escribe scripts reversibles hacia arriba y hacia abajo con pruebas
6. **Coordinación**: el agente comparte el esquema con AG-API y revisa sus consultas
7. **Optimización**: el agente agrega índices y evita patrones de consulta N+1
8. **Verificación**: el agente ejecuta pruebas para garantizar que todo pase
9. **Documentación**: El agente actualiza status.json y la aplicaciónfinaliza los mensajes del bus

## Ejemplo

```bash
# Via /babysit (recommended)
/agileflow:babysit
> "I need to design the database schema for users and posts"
```

El agente de base de datos:
1. Pregunte sobre las relaciones de datos (¿un usuario para muchas publicaciones?)
2. Diseño de esquema normalizado:
   - Tabla `users`: id, correo electrónico, nombre de usuario, contraseña_hash, creado_at, actualizado_at
   - Tabla `posts`: id, id_usuario, título, contenido, creado_en, actualizado_en
   - Restricción de clave externa: posts.user_id → users.id
3. Índices del plan: idx_users_email (para iniciar sesión), idx_posts_user_id (para consultas)
4. Cree un script de migración con operaciones arriba/abajo
5. Coordinar con AG-API sobre modelos y consultas ORM.
6. Pruebe la reversión de la migración antes de completarla

O generar directamente:

```text
Task(
  description: "Optimize slow user profile query",
  prompt: "Query is taking 2+ seconds. Need to analyze and add missing indexes.",
  subagent_type: "agileflow-database"
)
```

## Comportamientos clave

- **Nunca realice cambios sin migraciones**: todos los cambios de esquema requieren secuencias de comandos de migración reversibles
- **Modo de planificación para cambios de alto riesgo**: siempre utiliza el modo de planificación para diseñar esquema/estrategia de migración
- **Migraciones reversibles**: cada migración "hacia arriba" tiene su correspondiente "hacia abajo" para revertir
- **Optimización de consultas**: analiza consultaspara problemas N+1, índices faltantes, SELECT * antipatrones
- **Convenciones de nomenclatura**: tablas en plural minúscula (usuarios, publicaciones), columnas en mayúsculas y minúsculas (id_usuario, creado_at)
- **Columnas obligatorias**: cada tabla tiene id, creado_at, actualizado_at (y eliminado_at para eliminaciones temporales)
- **Coordinación con AG-API**: Revisa sus consultas y uso de ORM; sugiere optimizaciones
- **Integración del arnés de sesión**: verifica el estado de la prueba antes de comenzar, requiere pasar las pruebas antes de la revisión
- **Documentación proactiva**: crea ADR para decisiones importantes de esquema
- **Preservación del contexto**: utiliza compact_context (prioridad: alta) para mantener el enfoque durante conversaciones largas, preservando las decisiones de esquema y el seguimiento de la optimización del rendimiento a través de la compactación del contexto.

## Configuración de contexto compacto

El agente de base de datos utiliza compact_context de **alta prioridad** para garantizar que se conserven las decisiones de optimización y diseño del esquema:

```yaml
compact_context:
  priority: high
  preserve_rules:
    - "LOAD EXPERTISE FIRST: Always read packages/cli/src/core/experts/database/expertise.yaml"
    - "NEVER CHANGE SCHEMA WITHOUT MIGRATION: All changes require reversible up/down scripts"
    - "PLAN MODE FOR HIGH-RISK CHANGES: Design schema/migration strategy before implementation"
    - "VERIFY TEST BASELINE: Check test_status before starting new work"
    - "REQUIRED COLUMNS: Every table needs id, created_at, updated_at"
    - "COORDINATION WITH AG-API: Review their queries and ORM patterns"
  state_fields:
    - current_story
    - schema_changes_planned
    - migration_strategy
    - api_query_reviews
    - test_status_baseline
```

Esto garantiza reglas críticas para la base de datos (requisitos de migración, nombres de esquema).g, columnas requeridas) y el estado actual (qué cambios de esquema se planean, qué consultas de API deben revisarse) permanecen enfocados a través de la compactación del contexto.

## Herramientas disponibles

Este agente tiene acceso a: Leer, Escribir, Editar, Bash, Glob, Grep

## Principios de diseño de esquemas

**Normalización**: reduzca la redundancia de datos y mejore la integridad de los datos

- Minimizar datos duplicados
- Una fuente de verdad por campo.
- Desnormalizar sólo cuando las demandas de rendimiento lo justifiquen (documentar por qué)

**Convenciones de nomenclatura**:

- Tablas: minúsculas, plural (usuarios, productos, pedidos)
- Columnas: minúsculas, Snake_case (primer_nombre, creado_en)
- Claves externas: formato table_id (user_id, product_id)
- Índices: formato idx_table_column (idx_users_email)

**Columnas obligatorias**:

- `id`: Clave primaria (UUID o incremento automático)
- `created_at`: Cuándo se creó el registro
- `updated_at`: Cuándo se modificó el registro por última vez
- `deleted_at`: marca de tiempo de eliminación temporal (si se utilizan eliminaciones temporales)

**Relaciones**:

- Uno a muchos: clave externa en muchas tablas
- Muchos a muchos: tabla de conexiones con dos claves foráneas
- Uno a uno: clave externa con restricción única

## Patrones de optimización de consultas

**Identificar consultas lentas**:

```sql
-- Enable query logging for queries > 100ms
-- Use database explain plan
EXPLAIN ANALYZE SELECT ...
```

**Optimizar consultas**:

- Agregar índices en columnas consultadas con frecuencia (DÓNDE, UNIRSE, ORDENAR POR)
- Utilice EXPLAIN PLAN para verificar el uso del índice.
- Consultas por lotes (cargar varios registros en una sola consulta)
- Utilice CTE/funciones de ventana para agregaciones complejas

**Problemas comunes**:

```sql
-- BAD: N+1 problem
SELECT * FROM users;
-- Loop: SELECT * FROM posts WHERE user_id = $1;

-- GOOD: Single query with JOIN
SELECT users.*, posts.*
FROM users
LEFT JOIN posts ON users.id = posts.user_id;

-- BAD: Missing index
SELECT * FROM users WHERE email = $1;

-- GOOD: Add index on email
CREATE INDEX idx_users_email ON users(email);
```

## Mejores prácticas de migración

**Migraciones Seguras**:

1. Agregue nuevas columnas como anulables (se pueden rellenar gradualmente)
2. Cree índices antes de eliminar columnas antiguas
3. Pruebe el plan de reversión antes de implementarlo
4. Haga una copia de seguridad antes de ejecutar una migración destructiva
5. Ejecutar en la ventana de mantenimiento si es posible un impacto en la producción.

**Migraciones reversibles**:

- Cada migración "arriba" tiene su correspondiente "abajo"
- Migración hacia abajo probada antes de implementarla
- Ejemplo: Agregar columna (arriba) / Eliminar columna (abajo)

## Coordinación con AG-API

**Esquema DesFase de encendido**:

- AG-API describe las necesidades de datos
- Esquema de diseños AG-DATABASE
- Revisar juntos las oportunidades de optimización.

**Fase de Implementación**:

- AG-DATABASE crea un script de migración
- AG-API implementa modelos ORM
- Coordinar la carga de relaciones (ansioso vs perezoso)

**Fase de optimización de consultas**:

- AG-API desarrolla consulta
- Revisiones AG-DATABASE para N+1 y optimización
- Agregue índices según sea necesario

## Archivos clave

- **Experiencia**: `packages/cli/src/core/experts/database/expertise.yaml` (memoria del agente)
- **Flujo de trabajo**: `packages/cli/src/core/experts/database/workflow.md` (Planificar → Construir → Automejorar)
- **Estado**: `docs/09-agents/status.json` (seguimiento de la historia)
- **Bus**: `docs/09-agents/bus/log.jsonl` (mensajes de coordinación)
- **CLAUDE.md**: Tipo de base de datos e información ORM
- **Investigación**: `docs/10-research/` (verifique los patrones de diseño del esquema)
- **ADR**: `docs/03-decisions/` (decisiones de arquitectura de base de datos)

## Pasos del flujo de trabajo

1. **Cargar conocimientos**: lea experticia.yaml para cargar conocimientos del esquema.
2. **Revisar la historia**: identificar los requisitos y las relaciones de los datos
3. **Ingrese al modo de plan**: DDiseñar esquema, estrategia de migración, analizar impacto.
4. **Crear esquema**: definir tablas, columnas, restricciones y relaciones
5. **Crear migración**: escriba scripts reversibles hacia arriba/abajo
6. **Estado de actualización**: marcar "en curso"
7. **Agregar mensaje de bus**: coordinar con AG-API
8. **Probar migración**: probar operaciones de subida y bajada
9. **Optimizar**: agregar índices basados en patrones de consulta
10. **Verificar**: ejecutar pruebas para garantizar que se apruebe la línea base.
11. **Marcar en revisión**: actualiza el estado solo cuando test_status==aprueba
12. **Automejora**: ejecute self-improve.md una vez completado

## Lista de verificación de calidad

Antes de marcar en revisión:

- [] El esquema sigue las convenciones de nomenclatura
- [] Todas las columnas requeridas presentes (id, creado_at, actualizado_at)
- [ ] Relaciones correctamente definidas (claves externas, restricciones)
- [ ] Las migraciones son reversibles
- [] Migraciones probadas (arriba y abajo)
- [] Índices en columnas comúnmente consultadas
- [ ] No se prevén patrones de consulta N+1
- [] Se aplican restricciones de integridad de datos
- [] Los comentarios explican el complejo d.decisiones
- [] Procedimiento de copia de seguridad y recuperación documentado
- [] Estado de la prueba: aprobado (verificado mediante /agileflow:verify)

## Agentes relacionados

- [`api`](/agents/api) - Implementa modelos ORM y consultas basadas en esquema
- [`mentor`](/agents/mentor) - Orquesta el trabajo de la base de datos como parte de la implementación de funciones
- [`ci`](/agents/ci) - Configura bases de datos de prueba e infraestructura de prueba de migración