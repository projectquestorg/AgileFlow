---
title: قاعدة البيانات
description: متخصص في قواعد البيانات لتصميم المخططات والترحيلات وتحسين الاستعلامات ونمذجة البيانات.
---
# وكيل قاعدة البيانات

وكيل قاعدة البيانات (AG-DATABASE) هو متخصص في قاعدة البيانات الخاصة بك لتصميم مخططات فعالة وكتابة عمليات ترحيل آمنة وتحسين الاستعلامات وإدارة سلامة البيانات. إنه يضمن أن تكون طبقة قاعدة البيانات الخاصة بك فعالة وقابلة للصيانة وموثوقة.

## القدرات

- تصميم مخططات فعالة لقاعدة البيانات (الجداول، العلاقات، القيود)
- كتابة نصوص هجرة عكسية مع إستراتيجيات التراجع
- تحسين الاستعلامات البطيئة (تحديد الفهارس المفقودة وتحسين بنية الاستعلام)
- منع مشاكل استعلام N+1 وحدد * الأنماط المضادة
- ضمان سلامة البيانات من خلال القيود والتحقق من الصحة
- مراجعة الاستعلامات من AG-API لمشاكل الأداء
- توثيق نماذج البيانات والعلاقات مع ADRs الخاصة بالهندسة المعمارية
- التنسيق مع AG-API بشأن استخدام ORM وأنماط الاستعلام
- مراقبة الأداء وصحة قاعدة البيانات

## متى يستخدم

استخدم وكيل قاعدة البيانات عندما:

- أنت بحاجة إلى تصميم جدول أو بنية علاقة جديدة
- أنت بحاجة إلى إنشاء برنامج نصي للترحيل لتغييرات المخطط
- لاحظت قاستعلامات منخفضة أو مشكلات في الأداء
- تريد تحسين استعلام قاعدة بيانات معقدة
- أنت بحاجة إلى إضافة فهارس إلى الأعمدة التي يتم الاستعلام عنها بشكل متكرر
- أنت تقوم بتصميم نماذج بيانات لميزة جديدة
- تريد منع أنماط استعلام N+1 قبل حدوثها
- أنت بحاجة إلى تنسيق عمل طبقة البيانات مع AG-API

## كيف يعمل

1. **تحميل السياق**: يقرأ الوكيل الخبرة وCLAUDE.md وتكوين قاعدة البيانات
2. **مراجعة القصة**: يحدد الوكيل متطلبات البيانات والعلاقات
3. **وضع الخطة**: يقوم الوكيل بتصميم المخطط واستراتيجية الترحيل (للتغييرات عالية المخاطر)
4. **تصميم المخطط**: يقوم الوكيل بإنشاء مخططات لعلاقة الكيانات وتطبيع البيانات
5. **إنشاء الترحيل**: يقوم الوكيل بكتابة نصوص برمجية قابلة للعكس لأعلى/لأسفل مع الاختبار
6. **التنسيق**: يشارك الوكيل المخطط مع AG-API ويراجع استفساراته
7. **التحسين**: يضيف الوكيل الفهارس ويمنع أنماط استعلام N+1
8. **التحقق**: يجري الوكيل اختبارات للتأكد من اجتياز كل شيء
9. **الوثائق**: يقوم الوكيل بتحديث الحالة.json والتطبيقتنتهي رسائل الحافلة

## مثال

__لا تترجم_0__

سيقوم وكيل قاعدة البيانات بما يلي:
1. اسأل عن علاقات البيانات (مستخدم واحد للعديد من المشاركات؟)
2. تصميم المخطط الطبيعي:
   - `users` الجدول: المعرف، البريد الإلكتروني، اسم المستخدم،password_hash، create_at، Update_at
   - `posts` الجدول: المعرف، معرف_المستخدم، العنوان، المحتوى، تم إنشاؤه_في، تحديث_في
   - قيد المفتاح الخارجي: Posts.user_id → users.id
3. فهارس الخطة: idx_users_email (لتسجيل الدخول)، idx_posts_user_id (للاستعلامات)
4. قم بإنشاء برنامج نصي للترحيل مع عمليات لأعلى/لأسفل
5. التنسيق مع AG-API بشأن نماذج واستعلامات ORM
6. اختبر التراجع عن الترحيل قبل الانتهاء

أو تفرخ مباشرة:

__لا تترجم_1__

## السلوكيات الرئيسية

- **لا تقم مطلقًا بإجراء تغييرات بدون عمليات ترحيل**: تتطلب جميع تغييرات المخطط برامج نصية للترحيل قابلة للعكس
- **وضع الخطة للتغييرات عالية المخاطر**: يستخدم دائمًا وضع الخطة لتصميم المخطط/استراتيجية الترحيل
- **الهجرات العكسية**: كل عملية ترحيل "لأعلى" لها "هجرة لأسفل" مقابلة للتراجع
- **تحسين الاستعلام**: تحليل الاستعلاماتلمشاكل N+1، الفهارس المفقودة، SELECT * الأنماط المضادة
- **اصطلاحات التسمية**: الجداول بصيغة الجمع الصغيرة (المستخدمون، المنشورات)، والأعمدة ثعبان_حالة (user_id، create_at)
- **الأعمدة المطلوبة**: يحتوي كل جدول على معرف، وcreate_at، وupdate_at (وdelete_at لعمليات الحذف البسيطة)
- **التنسيق مع AG-API**: مراجعة استفساراتهم واستخدام ORM؛ يقترح التحسينات
- **تكامل أدوات الجلسة**: التحقق من حالة الاختبار قبل البدء، ويتطلب اجتياز الاختبارات قبل المراجعة
- **التوثيق الاستباقي**: ينشئ ADRs لقرارات المخطط الرئيسية
- **الحفاظ على السياق**: يستخدم Compact_context (الأولوية: عالية) للحفاظ على التركيز أثناء المحادثات الطويلة، والحفاظ على قرارات المخطط وتتبع تحسين الأداء من خلال ضغط السياق

## تكوين السياق المضغوط

يستخدم وكيل قاعدة البيانات **أولوية عالية** Compact_context لضمان الحفاظ على تصميم المخطط وقرارات التحسين:

__لا تترجم_2__

وهذا يضمن القواعد الهامة لقاعدة البيانات (متطلبات الترحيل، schema naming، والأعمدة المطلوبة) والحالة الحالية (ما هي تغييرات المخطط المخطط لها، وما هي استعلامات واجهة برمجة التطبيقات التي تحتاج إلى مراجعة) تظل موضع التركيز من خلال ضغط السياق.

## الأدوات المتاحة

هذا الوكيل لديه حق الوصول إلى: القراءة، الكتابة، التحرير، Bash، Glob، Grep

## مبادئ تصميم المخطط

**التطبيع**: تقليل تكرار البيانات مع تحسين تكامل البيانات

- تقليل البيانات المكررة
- مصدر واحد للحقيقة في كل مجال
- عدم الضبط الطبيعي إلا عندما تبرر متطلبات الأداء ذلك (توثيق السبب)

** اصطلاحات التسمية **:

- الجداول: صغيرة، الجمع (المستخدمين، المنتجات، الطلبات)
- الأعمدة: أحرف صغيرة، وsnake_case (الاسم_الأول، وcreate_at)
- المفاتيح الخارجية: تنسيق table_id (user_id، Product_id)
- الفهارس: تنسيق idx_table_column (idx_users_email)

**الأعمدة المطلوبة**:

- `id`: المفتاح الأساسي (UUID أو الزيادة التلقائية)
- `created_at`: عندما تم إنشاء السجل
- `updated_at`: متى تم تعديل السجل آخر مرة
- `deleted_at`: الطابع الزمني للحذف المبدئي (في حالة استخدام الحذف المبدئي)

** العلاقات **:

- واحد لكثير: المفتاح الخارجي في العديد من الجداول
- متعدد إلى متعدد: جدول توصيل بمفتاحين خارجيين
- واحد لواحد: مفتاح خارجي مع قيد فريد

## أنماط تحسين الاستعلام

**تحديد الاستعلامات البطيئة**:

__لا تترجم_3__

**تحسين الاستعلامات**:

- إضافة فهارس على الأعمدة التي يتم الاستعلام عنها بشكل متكرر (أين، انضم، ORDER BY)
- استخدم EXPLAIN PLAN للتحقق من استخدام الفهرس
- الاستعلامات المجمعة (تحميل سجلات متعددة في استعلام واحد)
- استخدم وظائف CTE/النافذة للتجمعات المعقدة

** المشكلات الشائعة **:

__لا تترجم_4__

## أفضل ممارسات الهجرة

**الهجرات الآمنة**:

1. أضف أعمدة جديدة كأعمدة فارغة (يمكن إعادة ملئها تدريجيًا)
2. قم بإنشاء فهارس قبل إسقاط الأعمدة القديمة
3. اختبار خطة التراجع قبل النشر
4. النسخ الاحتياطي قبل تشغيل الترحيل المدمر
5. قم بالتشغيل في نافذة الصيانة إذا كان التأثير على الإنتاج ممكنًا

**الهجرات العكسية**:

- كل هجرة "لأعلى" لها مقابلة "لأسفل"
- تم اختبار الترحيل للأسفل قبل النشر للأعلى
- مثال: إضافة عمود (أعلى) / عمود إسقاط (أسفل)

## التنسيق مع AG-API

**مخطط التصميممرحلة الإشعال**:

- يصف AG-API احتياجات البيانات
- مخطط تصاميم AG-DATABASE
- المراجعة معًا للحصول على فرص التحسين

**مرحلة التنفيذ**:

- تقوم AG-DATABASE بإنشاء برنامج نصي للترحيل
- AG-API تنفذ نماذج ORM
- التنسيق على تحميل العلاقة (حريص مقابل كسول)

**مرحلة تحسين الاستعلام**:

- يقوم AG-API بتطوير الاستعلام
- مراجعات AG-DATABASE لـ N+1 والتحسين
- إضافة الفهارس حسب الحاجة

## الملفات الرئيسية

- **الخبرة**: `packages/cli/src/core/experts/database/expertise.yaml` (ذاكرة الوكيل)
- **سير العمل**: `packages/cli/src/core/experts/database/workflow.md` (الخطة → البناء → التحسين الذاتي)
- **الحالة**: `docs/09-agents/status.json` (تتبع القصة)
- **الحافلة**: `docs/09-agents/bus/log.jsonl` (رسائل التنسيق)
- **CLAUDE.md**: نوع قاعدة البيانات ومعلومات ORM
- **البحث**: `docs/10-research/` (تحقق من أنماط تصميم المخطط)
- **ADRs**: `docs/03-decisions/` (قرارات بنية قاعدة البيانات)

## خطوات سير العمل

1. **تحميل الخبرة**: اقرأ Expert.yaml لتحميل معرفة المخطط
2. **مراجعة القصة**: تحديد متطلبات البيانات والعلاقات
3. **الدخول إلى وضع الخطة**: دمخطط التصميم، استراتيجية الهجرة، تحليل التأثير
4. **إنشاء مخطط**: تحديد الجداول والأعمدة والقيود والعلاقات
5. **إنشاء الترحيل**: اكتب نصوص برمجية قابلة للعكس لأعلى/لأسفل
6. **حالة التحديث**: ضع علامة "قيد التقدم"
7. **إلحاق رسالة الناقل**: التنسيق مع AG-API
8. **اختبار الترحيل**: اختبار العمليات لأعلى ولأسفل
9. **التحسين**: أضف فهارس بناءً على أنماط الاستعلام
10. **التحقق**: قم بإجراء الاختبارات للتأكد من اجتياز خط الأساس
11. **وضع علامة قيد المراجعة**: تحديث الحالة فقط عند اجتياز test_status==
12. **التحسين الذاتي**: قم بتشغيل self-improve.md بعد الانتهاء

## قائمة التحقق من الجودة

قبل وضع علامة في المراجعة:

- [ ] يتبع المخطط اصطلاحات التسمية
- [ ] جميع الأعمدة المطلوبة موجودة (id، create_at، Update_at)
- [ ] العلاقات محددة بشكل صحيح (المفاتيح الخارجية، القيود)
- [ ] الهجرات قابلة للعكس
- [ ] تم اختبار الهجرات (أعلى وأسفل)
- [ ] فهارس الأعمدة التي يتم الاستعلام عنها بشكل شائع
- [ ] لا توجد أنماط استعلام N+1 متوقعة
- [ ] فرض قيود على سلامة البيانات
- [ ] تعليقات شرح مجمع دecisions
- [ ] توثيق إجراءات النسخ الاحتياطي والاسترداد
- [ ] حالة الاختبار: ناجح (تم التحقق منه عبر /agileflow:verify)

## الوكلاء ذوو الصلة

- [`api`](/agents/api) - تنفيذ نماذج واستعلامات ORM بناءً على المخطط
- [`mentor`](/agents/mentor) - ينسق عمل قاعدة البيانات كجزء من تنفيذ الميزة
- [`ci`](/agents/ci) - إعداد قواعد بيانات الاختبار والبنية الأساسية لاختبار الترحيل