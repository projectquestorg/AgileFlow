---
title: / Agileflow:الإعداد:visual-e2e
description: قم بإعداد البنية الأساسية لاختبار Visual E2E باستخدام Playwright والتحقق من لقطة الشاشة
---

# / Agileflow:الإعداد:visual-e2e

قم بإعداد البنية الأساسية لاختبار Visual E2E باستخدام Playwright وسير عمل التحقق من لقطة الشاشة.

## بداية سريعة

```bash
/agileflow:setup:visual-e2e
```

## غاية

يقوم بإعداد بنية أساسية كاملة لاختبار Visual E2E بما في ذلك:

- تثبيت الكاتب المسرحي مع تبعيات المتصفح
- `playwright.config.ts` مع التشغيل التلقائي لخادم الويب
- مثال لاختبار E2E مع التقاط لقطة الشاشة
- دليل لقطات الشاشة للتحقق البصري
- البرامج النصية npm لإجراء الاختبارات

## لماذا فيجوال E2E؟

**The problem**: تم اجتياز الاختبارات ولكن واجهة المستخدم معطلة.

الاختبارات الوظيفية تتحقق من السلوك ولكن ليس المظهر البصري. يمكن للزر "العمل" ولكنه يكون:
- لون خاطئ
- موقف خاطئ
- تداخل العناصر الأخرى
- مفقود تمامًا (تم استبداله بحالة الخطأ)

يكتشف Visual E2E مع التحقق من لقطة الشاشة هذه المشكلات.

## ما يتم إنشاؤه

### playwright.config.ts

تكوين الكاتب المسرحي مع webServer لبدء تشغيل خادم التطوير الخاص بك تلقائيًا:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,

  use: {
    baseURL: 'http://localhost:3000',
    screenshot: 'on',
    trace: 'on-first-retry',
  },

  // Auto-start dev server
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
```

### اختبار المثال

`tests/e2e/visual-example.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Visual Verification Examples', () => {
  test('homepage loads correctly', async ({ page }) => {
    await page.goto('/');

    // Capture full-page screenshot for visual verification
    await page.screenshot({
      path: 'screenshots/homepage-full.png',
      fullPage: true,
    });

    // Basic assertions
    await expect(page).toHaveTitle(/./);
  });
});
```

### هيكل الدليل

```
your-project/
├── playwright.config.ts
├── tests/
│   └── e2e/
│       └── visual-example.spec.ts
├── screenshots/
│   ├── homepage-full.png          # After test runs
│   └── verified-homepage-full.png # After visual review
└── package.json                   # Updated with test:e2e scripts
```

### البرامج النصية npm

يضاف إلى `package.json`:

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed"
  }
}
```

## خطوات الإعداد

يقوم الأمر بتنفيذ الخطوات الثمانية التالية:

1. **Check package.json** - التحقق من أن المشروع يحتوي على إعداد npm
2. **Install Playwright** - `npm install --save-dev @playwright/test`
3. **Install browser** - `npx playwright install --with-deps chromium`
4. **Create config** - `playwright.config.ts` مع خادم الويب
5. **Create test directory** - `tests/e2e/`
6. **Create screenshots directory** - `screenshots/`
7. **Create example test** - اختبار مع التقاط لقطة للشاشة
8. **Add npm scripts** - `test:e2e` مخطوطات
9. **Run verification** - تنفيذ اختبار المثال

## سير عمل التحقق المرئي

بعد إجراء الاختبارات، تحتاج لقطات الشاشة إلى مراجعة مرئية:

### 1. تشغيل الاختبارات

```bash
npm run test:e2e
```

تقوم الاختبارات بإنشاء لقطات شاشة في `screenshots/` دليل.

### 2. قم بمراجعة لقطات الشاشة

يقوم كلود بمراجعة كل لقطة شاشة للتأكد من أن واجهة المستخدم تبدو صحيحة.

### 3. التحقق وإعادة التسمية

تتم إعادة تسمية لقطات الشاشة المعتمدة بـ `verified-` بادئة:

```bash
mv screenshots/homepage.png screenshots/verified-homepage.png
```

### 4. قم بتشغيل أداة التحقق

```bash
node scripts/screenshot-verifier.js --path ./screenshots
```

وهذا يضمن مراجعة جميع لقطات الشاشة قبل وضع علامة على اكتمال العمل.

## التكامل مع وضع الحلقة

يتكامل Visual E2E مع [وضع الحلقة](/features/loop-mode) لتطوير واجهة المستخدم المستقلة:

```bash
# Initialize loop with Visual Mode
/agileflow:babysit EPIC=EP-0042 MODE=loop VISUAL=true
```

في الوضع المرئي، تتحقق الحلقة مما يلي:
1. تمر الاختبارات
2. جميع لقطات الشاشة لها `verified-` بادئة
3. تم إكمال نسختين على الأقل

وهذا يمنع الانتهاء المبكر من عمل واجهة المستخدم.

## حدود

| Parameter | Default | Description |
|-----------|---------|-------------|
| DEV_CMD | `npm run dev` | Dev server command |
| PORT | `3000` | Dev server port |
| BROWSER | `chromium` | Browser to install (chromium is smallest, ~300MB) |

## تشغيل الاختبارات

بعد الإعداد:

```bash
# Run all E2E tests
npm run test:e2e

# Run with UI (interactive mode)
npm run test:e2e:ui

# Run with visible browser
npm run test:e2e:headed

# Run specific test
npx playwright test tests/e2e/visual-example.spec.ts
```

## أفضل الممارسات

### 1. التقاط صفحات كاملة

للتحقق البصري، التقط الصفحات الكاملة:

```typescript
await page.screenshot({
  path: 'screenshots/homepage.png',
  fullPage: true,
});
```

### 2. التقاط المكونات

للاختبارات الخاصة بالمكونات:

```typescript
const header = page.locator('header').first();
await header.screenshot({
  path: 'screenshots/header.png',
});
```

### 3. قم بتسمية لقطات الشاشة بشكل وصفي

```
screenshots/
├── login-form-empty.png
├── login-form-filled.png
├── login-form-error.png
└── dashboard-loaded.png
```

### 4. اختبار الدول المختلفة

```typescript
// Empty state
await page.screenshot({ path: 'screenshots/list-empty.png' });

// Loading state
await page.goto('/users');
await page.screenshot({ path: 'screenshots/list-loading.png' });

// Loaded state
await page.waitForSelector('[data-testid="user-list"]');
await page.screenshot({ path: 'screenshots/list-loaded.png' });
```

## استكشاف الأخطاء وإصلاحها

### لم يتم العثور على المتصفح

إذا لم يتمكن الكاتب المسرحي من العثور على المتصفح:

```bash
npx playwright install --with-deps chromium
```

### خادم التطوير لا يبدأ

تحقق الخاص بك `package.json` لديه أمر التطوير الصحيح:

```json
{
  "scripts": {
    "dev": "next dev"  // or your dev command
  }
}
```

### دليل لقطات الشاشة مفقود

تأكد من وجود الدليل قبل تشغيل الاختبارات:

```bash
mkdir -p screenshots
```

### مهلة الاختبارات

زيادة مهلة خادم الويب في التكوين:

```typescript
webServer: {
  command: 'npm run dev',
  timeout: 180000,  // 3 minutes
}
```

## متعلق ب

- [الوضع المرئي](/features/visual-mode) - نظام التحقق من لقطة الشاشة
- [وضع الحلقة](/features/loop-mode) - معالجة القصة المستقلة
- [`/ Agileflow: التحقق`](/commands/verify) - إجراء الاختبارات والتحقق
- [`/ Agileflow: الاختبارات`](/commands/tests) - اختبار إعداد البنية التحتية
