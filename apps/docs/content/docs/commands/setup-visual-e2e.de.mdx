---
title: /agileflow:setup:visual-e2e
description: Richten Sie eine Visual E2E-Testinfrastruktur mit Playwright und Screenshot-Verifizierung ein
---

# /agileflow:setup:visual-e2e

Richten Sie eine Visual E2E-Testinfrastruktur mit Playwright und einen Workflow zur Screenshot-Verifizierung ein.

## Schnellstart

```bash
/agileflow:setup:visual-e2e
```

## Zweck

Richtet eine vollständige Visual E2E-Testinfrastruktur ein, einschließlich:

- Playwright-Installation mit Browserabhängigkeiten
- `playwright.config.ts` mit WebServer-Autostart
- Beispiel eines E2E-Tests mit Screenshot-Aufnahme
- Screenshots-Verzeichnis zur visuellen Überprüfung
- npm-Skripte zum Ausführen von Tests

## Warum Visual E2E?

**The problem**: Tests bestehen, aber die Benutzeroberfläche ist fehlerhaft.

Funktionstests überprüfen das Verhalten, nicht jedoch das optische Erscheinungsbild. Eine Schaltfläche kann „funktionieren“, aber sein:
- Falsche Farbe
- Falsche Position
- Überlappung anderer Elemente
- Fehlt vollständig (ersetzt durch Fehlerstatus)

Visual E2E mit Screenshot-Überprüfung erkennt diese Probleme.

## Was entsteht

### playwright.config.ts

Playwright-Konfiguration mit webServer zum automatischen Starten Ihres Entwicklungsservers:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,

  use: {
    baseURL: 'http://localhost:3000',
    screenshot: 'on',
    trace: 'on-first-retry',
  },

  // Auto-start dev server
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
```

### Beispieltest

`tests/e2e/visual-example.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Visual Verification Examples', () => {
  test('homepage loads correctly', async ({ page }) => {
    await page.goto('/');

    // Capture full-page screenshot for visual verification
    await page.screenshot({
      path: 'screenshots/homepage-full.png',
      fullPage: true,
    });

    // Basic assertions
    await expect(page).toHaveTitle(/./);
  });
});
```

### Verzeichnisstruktur

```
your-project/
├── playwright.config.ts
├── tests/
│   └── e2e/
│       └── visual-example.spec.ts
├── screenshots/
│   ├── homepage-full.png          # After test runs
│   └── verified-homepage-full.png # After visual review
└── package.json                   # Updated with test:e2e scripts
```

### npm-Skripte

Hinzugefügt `package.json`:

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed"
  }
}
```

## Einrichtungsschritte

Der Befehl führt diese 8 Schritte aus:

1. **Check package.json** – Überprüfen Sie, ob das Projekt über ein NPM-Setup verfügt
2. **Install Playwright** - `npm install --save-dev @playwright/test`
3. **Install browser** - `npx playwright install --with-deps chromium`
4. **Create config** - `playwright.config.ts` mit Webserver
5. **Create test directory** - `tests/e2e/`
6. **Create screenshots directory** - `screenshots/`
7. **Create example test** - Testen Sie mit Screenshot-Erfassung
8. **Add npm scripts** - `test:e2e` Skripte
9. **Run verification** - Beispieltest durchführen

## Visueller Verifizierungsworkflow

Nachdem die Tests ausgeführt wurden, müssen die Screenshots visuell überprüft werden:

### 1. Führen Sie Tests durch

```bash
npm run test:e2e
```

Tests generieren Screenshots in `screenshots/` Verzeichnis.

### 2. Überprüfen Sie die Screenshots

Claude überprüft jeden Screenshot, um sicherzustellen, dass die Benutzeroberfläche korrekt aussieht.

### 3. Überprüfen und umbenennen

Genehmigte Screenshots werden mit umbenannt `verified-` Präfix:

```bash
mv screenshots/homepage.png screenshots/verified-homepage.png
```

### 4. Führen Sie Verifier aus

```bash
node scripts/screenshot-verifier.js --path ./screenshots
```

Dadurch wird sichergestellt, dass alle Screenshots überprüft wurden, bevor die Arbeit als abgeschlossen markiert wird.

## Integration mit Loop-Modus

Visual E2E lässt sich integrieren mit [Loop-Modus](/features/loop-mode) für autonome UI-Entwicklung:

```bash
# Initialize loop with Visual Mode
/agileflow:babysit EPIC=EP-0042 MODE=loop VISUAL=true
```

Im visuellen Modus prüft die Schleife Folgendes:
1. Tests bestehen
2. Alle Screenshots haben `verified-` Präfix
3. Mindestens 2 Iterationen abgeschlossen

Dies verhindert einen vorzeitigen Abschluss der UI-Arbeit.

## Parameter

| Parameter | Default | Description |
|-----------|---------|-------------|
| DEV_CMD | `npm run dev` | Dev server command |
| PORT | `3000` | Dev server port |
| BROWSER | `chromium` | Browser to install (chromium is smallest, ~300MB) |

## Ausführen von Tests

Nach der Einrichtung:

```bash
# Run all E2E tests
npm run test:e2e

# Run with UI (interactive mode)
npm run test:e2e:ui

# Run with visible browser
npm run test:e2e:headed

# Run specific test
npx playwright test tests/e2e/visual-example.spec.ts
```

## Best Practices

### 1. Erfassen Sie ganze Seiten

Erfassen Sie zur visuellen Überprüfung ganze Seiten:

```typescript
await page.screenshot({
  path: 'screenshots/homepage.png',
  fullPage: true,
});
```

### 2. Komponenten erfassen

Für komponentenspezifische Tests:

```typescript
const header = page.locator('header').first();
await header.screenshot({
  path: 'screenshots/header.png',
});
```

### 3. Benennen Sie Screenshots beschreibend

```
screenshots/
├── login-form-empty.png
├── login-form-filled.png
├── login-form-error.png
└── dashboard-loaded.png
```

### 4. Testen Sie verschiedene Zustände

```typescript
// Empty state
await page.screenshot({ path: 'screenshots/list-empty.png' });

// Loading state
await page.goto('/users');
await page.screenshot({ path: 'screenshots/list-loading.png' });

// Loaded state
await page.waitForSelector('[data-testid="user-list"]');
await page.screenshot({ path: 'screenshots/list-loaded.png' });
```

## Fehlerbehebung

### Browser nicht gefunden

Wenn Playwright den Browser nicht finden kann:

```bash
npx playwright install --with-deps chromium
```

### Dev-Server startet nicht

Überprüfen Sie Ihre `package.json` hat den richtigen Dev-Befehl:

```json
{
  "scripts": {
    "dev": "next dev"  // or your dev command
  }
}
```

### Screenshots-Verzeichnis fehlt

Stellen Sie sicher, dass das Verzeichnis vorhanden ist, bevor Sie Tests ausführen:

```bash
mkdir -p screenshots
```

### Zeitüberschreitung bei Tests

Erhöhen Sie das WebServer-Timeout in der Konfiguration:

```typescript
webServer: {
  command: 'npm run dev',
  timeout: 180000,  // 3 minutes
}
```

## Verwandt

- [Visueller Modus](/features/visual-mode) - Screenshot-Verifizierungssystem
- [Loop-Modus](/features/loop-mode) - Autonome Story-Verarbeitung
- [`/agileflow:verify`](/commands/verify) - Führen Sie Tests und Überprüfungen durch
- [`/agileflow:tests`](/commands/tests) - Testen der Infrastruktureinrichtung
